{% extends "base.html" %}
{% block title %}Edit {{ motor.load_type.title() }} - {{ motor.motor_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Edit {{ motor.load_type.title() }} - {{ motor.motor_name }}</h2>
                <a href="{{ url_for('motors.list_motors', project_id=project.project_id) }}" 
                   class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Motor/Load List
                </a>
            </div>

            <form method="POST" id="motorForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <div class="row">
                    <!-- Basic Motor Information -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="load_type" class="form-label">Type <span class="text-danger">*</span></label>
                                            <select class="form-select" id="load_type" name="load_type" required>
                                                <option value="motor" {{ 'selected' if motor.load_type == 'motor' }}>Motor</option>
                                                <option value="load" {{ 'selected' if motor.load_type == 'load' }}>Load</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="motor_name" class="form-label">Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="motor_name" name="motor_name" 
                                                   value="{{ motor.motor_name }}" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           value="{{ motor.location or '' }}" placeholder="e.g., DRV01, Panel A">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="encl_type" class="form-label">Enclosure Type</label>
                                            <input type="text" class="form-control" id="encl_type" name="encl_type" 
                                                   value="{{ motor.encl_type or '' }}" placeholder="e.g., TEFC, ODP">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="frame" class="form-label">Frame</label>
                                            <input type="text" class="form-control" id="frame" name="frame" 
                                                   value="{{ motor.frame or '' }}" placeholder="e.g., 56, 145T">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="speed_range" class="form-label">Speed Range</label>
                                    <input type="text" class="form-control" id="speed_range" name="speed_range" 
                                           value="{{ motor.speed_range or '' }}" placeholder="e.g., 1750 RPM">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="additional_notes" class="form-label">Additional Notes</label>
                                    <textarea class="form-control" id="additional_notes" name="additional_notes" rows="3">{{ motor.additional_notes or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Motor Specifications -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Motor Specifications</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="hp" class="form-label">Horsepower (HP) <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="hp" name="hp" step="0.25" min="0.5" 
                                                   value="{{ motor.hp }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="voltage" class="form-label">Voltage <span class="text-danger">*</span></label>
                                            <select class="form-select" id="voltage" name="voltage" required>
                                                <option value="">Select Voltage</option>
                                                {% for voltage_option in voltage_options %}
                                                <option value="{{ voltage_option }}" {{ 'selected' if motor.voltage == voltage_option }}>{{ voltage_option }}V</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="qty" class="form-label">Quantity <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="qty" name="qty" min="1" 
                                                   value="{{ motor.qty }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="overload_percentage" class="form-label">Overload % <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="overload_percentage" name="overload_percentage" 
                                                   step="0.01" min="1.00" max="2.00" value="{{ motor.overload_percentage }}" required>
                                            <div class="form-text">Usually 1.15 (115%) or 1.25 (125%)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="continuous_load" class="form-label">Continuous Load</label>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="continuous_load" name="continuous_load"
                                                       {{ 'checked' if motor.continuous_load }}>
                                                <label class="form-check-label" for="continuous_load">
                                                    Continuous (125%)
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                <strong>NEC Article 100:</strong> A load where maximum current is expected to continue for 3 hours or more
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- NEC Amps Override -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="nec_amps_override" name="nec_amps_override"
                                               {{ 'checked' if motor.nec_amps_override }}>
                                        <label class="form-check-label" for="nec_amps_override">
                                            Override NEC Motor Amps
                                        </label>
                                    </div>
                                    <div id="manual_amps_group" class="mt-2" style="display: {{ 'block' if motor.nec_amps_override else 'none' }};">
                                        <label for="manual_amps" class="form-label">Manual Amps</label>
                                        <input type="number" class="form-control" id="manual_amps" name="manual_amps" step="0.1" min="0"
                                               value="{{ motor.manual_amps or '' }}">
                                        <div class="form-text">Override calculated NEC amps (for non-standard motors)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VFD Selection -->
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">VFD Selection</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="vfd_type_id" class="form-label">VFD Type</label>
                                            <select class="form-select" id="vfd_type_id" name="vfd_type_id">
                                                <option value="">Select VFD Type</option>
                                                {% for vfd_type in vfd_types %}
                                                <option value="{{ vfd_type.vfd_type_id }}" {{ 'selected' if motor.vfd_type_id == vfd_type.vfd_type_id }}>
                                                    {{ vfd_type.type_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="duty_type" class="form-label">Duty Type <span class="text-danger">*</span></label>
                                            <select class="form-select" id="duty_type" name="duty_type" required>
                                                <option value="ND" {{ 'selected' if motor.duty_type == 'ND' or not motor.duty_type }}>Normal Duty (ND)</option>
                                                <option value="HD" {{ 'selected' if motor.duty_type == 'HD' }}>Heavy Duty (HD)</option>
                                            </select>
                                            <div class="form-text">Determines VFD input current calculation</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Calculated Values -->
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Current Calculated Values</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Motor Amps</label>
                                            <div class="form-control-plaintext">{{ "%.1f"|format(motor.motor_amps) }}A</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total Amps</label>
                                            <div class="form-control-plaintext">{{ "%.1f"|format(motor.total_amps) }}A</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Drive Required</label>
                                            <div class="form-control-plaintext">{{ "%.1f"|format(motor.drive_required_current) }}A</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Current VFD</label>
                                            <div class="form-control-plaintext">
                                                {% if motor.recommended_vfd %}
                                                    {{ motor.recommended_vfd.part_number }}<br>
                                                    <small class="text-muted">({{ motor.recommended_vfd.rating }}A)</small>
                                                {% else %}
                                                    <span class="text-muted">None</span>
                                                {% endif %}
                                            </div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="vfd_override" name="vfd_override"
                                                       {{ 'checked' if motor.vfd_override }}>
                                                <label class="form-check-label" for="vfd_override">
                                                    Override Recommended VFD
                                                </label>
                                            </div>
                                            <div id="vfd_override_group" class="mt-2" style="display: {{ 'block' if motor.vfd_override else 'none' }};">
                                                <select class="form-select" id="selected_vfd_part_id" name="selected_vfd_part_id">
                                                    <option value="">Select VFD</option>
                                                    {% for vfd in vfd_options %}
                                                    <option value="{{ vfd.part_id }}" {{ 'selected' if motor.selected_vfd_part_id == vfd.part_id }}>
                                                        {{ vfd.part_number }} - {{ vfd.rating }}A - ${{ "%.2f"|format(vfd.current_price) }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">Choose a specific VFD instead of auto-selection</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if motor.recommended_vfd %}
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Input Current</label>
                                            <div class="form-control-plaintext">{{ "%.1f"|format(motor.vfd_input_current) }}A</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total Input Current</label>
                                            <div class="form-control-plaintext">{{ "%.1f"|format(motor.total_vfd_input_current) }}A</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Heat Loss</label>
                                            <div class="form-control-plaintext">{{ "%.0f"|format(motor.vfd_heat_loss) }}W</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total Width</label>
                                            <div class="form-control-plaintext">{{ "%.2f"|format(motor.total_width) }}"</div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revision Control -->
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-code-branch"></i> Revision Control
                                    <span class="badge bg-light text-dark float-end">Current: v{{ motor.revision_number }}</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>How it works:</strong> Similar to SharePoint version control, you can choose how to save your changes:
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Major Revision</strong> - Significant changes (HP, voltage, VFD type) → v1.0 → v2.0</li>
                                        <li><strong>Minor Revision</strong> - Small changes (quantity, location, notes) → v1.0 → v1.1</li>
                                        <li><strong>Overwrite Current</strong> - Typo fixes, no version change → v1.0 → v1.0</li>
                                    </ul>
                                </div>

                                <div id="change-detection-status" class="alert alert-secondary" style="display:none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                            <span class="visually-hidden">Detecting changes...</span>
                                        </div>
                                        <span>Analyzing changes...</span>
                                    </div>
                                </div>

                                <div id="changes-detected" style="display:none;">
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle"></i> Changes Detected</h6>
                                        <div id="changed-fields-list"></div>
                                        <div class="mt-2">
                                            <strong>Suggested:</strong> <span id="suggested-revision-type" class="badge bg-primary"></span>
                                            <span class="ms-2">→</span>
                                            <span id="suggested-next-version" class="badge bg-success"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="revision_type" class="form-label">Save As <span class="text-danger">*</span></label>
                                            <select class="form-select form-select-lg" id="revision_type" name="revision_type" required>
                                                <option value="minor" selected>Minor Revision</option>
                                                <option value="major">Major Revision</option>
                                                <option value="overwrite">Overwrite Current</option>
                                            </select>
                                            <div class="form-text">
                                                Next version: <strong><span id="next-version-display">v{{ motor.increment_revision('minor') }}</span></strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="change_description" class="form-label">Change Description (Optional)</label>
                                            <textarea class="form-control" id="change_description" name="change_description"
                                                      rows="3" placeholder="Describe what you changed and why..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-outline-info" id="view-revision-history">
                                        <i class="fas fa-history"></i> View Revision History
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="detect-changes-btn">
                                        <i class="fas fa-search"></i> Analyze Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('motors.list_motors', project_id=project.project_id) }}"
                       class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle NEC amps override
    const necOverrideCheckbox = document.getElementById('nec_amps_override');
    const manualAmpsGroup = document.getElementById('manual_amps_group');
    
    necOverrideCheckbox.addEventListener('change', function() {
        manualAmpsGroup.style.display = this.checked ? 'block' : 'none';
    });

    // Toggle VFD override
    const vfdOverrideCheckbox = document.getElementById('vfd_override');
    const vfdOverrideGroup = document.getElementById('vfd_override_group');
    
    vfdOverrideCheckbox.addEventListener('change', function() {
        vfdOverrideGroup.style.display = this.checked ? 'block' : 'none';
        updateVFDOptions();
    });

    // Update VFD options when type changes
    document.getElementById('vfd_type_id').addEventListener('change', updateVFDOptions);

    function updateVFDOptions() {
        const vfdTypeId = document.getElementById('vfd_type_id').value;
        const currentSelection = document.getElementById('selected_vfd_part_id').value;
        
        const vfdSelect = document.getElementById('selected_vfd_part_id');
        vfdSelect.innerHTML = '<option value="">Select VFD</option>';

        if (!vfdTypeId) return;

        // Get drive required current from current motor data
        const driveRequired = {{ motor.drive_required_current }};

        fetch(`/motors/api/vfd_options_by_type?vfd_type_id=${vfdTypeId}&required_current=${driveRequired}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(vfd => {
                    const option = document.createElement('option');
                    option.value = vfd.part_id;
                    option.textContent = `${vfd.part_number} - ${vfd.rating}A - $${vfd.current_price.toFixed(2)}`;
                    if (vfd.part_id == currentSelection) {
                        option.selected = true;
                    }
                    vfdSelect.appendChild(option);
                });
            });
    }

    // Initialize VFD options if type is already selected
    if (document.getElementById('vfd_type_id').value) {
        updateVFDOptions();
    }

    // Revision control functionality
    const revisionTypeSelect = document.getElementById('revision_type');
    const nextVersionDisplay = document.getElementById('next-version-display');
    const detectChangesBtn = document.getElementById('detect-changes-btn');
    const motorForm = document.getElementById('motorForm');

    // Update next version display when revision type changes
    revisionTypeSelect.addEventListener('change', function() {
        const currentRevision = '{{ motor.revision_number }}';
        const revisionType = this.value;

        let nextVersion;
        if (revisionType === 'overwrite') {
            nextVersion = currentRevision;
        } else if (revisionType === 'major') {
            nextVersion = '{{ motor.increment_revision("major") }}';
        } else {
            nextVersion = '{{ motor.increment_revision("minor") }}';
        }

        nextVersionDisplay.textContent = 'v' + nextVersion;
    });

    // Detect changes before saving
    detectChangesBtn.addEventListener('click', function() {
        const formData = new FormData(motorForm);
        const changeDetectionStatus = document.getElementById('change-detection-status');
        const changesDetected = document.getElementById('changes-detected');

        changeDetectionStatus.style.display = 'block';
        changesDetected.style.display = 'none';

        fetch('/motors/edit/{{ motor.motor_id }}/detect_changes', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            changeDetectionStatus.style.display = 'none';

            if (data.success) {
                if (Object.keys(data.changed_fields).length > 0) {
                    changesDetected.style.display = 'block';

                    // Display changed fields
                    const changedFieldsList = document.getElementById('changed-fields-list');
                    let fieldsHtml = '<ul class="mb-0">';
                    for (const [field, values] of Object.entries(data.changed_fields)) {
                        const oldVal = values.old !== null ? values.old : '(empty)';
                        const newVal = values.new !== null ? values.new : '(empty)';
                        fieldsHtml += `<li><strong>${field}:</strong> ${oldVal} → ${newVal}</li>`;
                    }
                    fieldsHtml += '</ul>';
                    changedFieldsList.innerHTML = fieldsHtml;

                    // Show suggestion
                    const suggestedType = data.suggested_revision_type;
                    document.getElementById('suggested-revision-type').textContent = suggestedType.toUpperCase();

                    let suggestedNextVersion;
                    if (suggestedType === 'major') {
                        suggestedNextVersion = data.next_major;
                    } else if (suggestedType === 'minor') {
                        suggestedNextVersion = data.next_minor;
                    } else {
                        suggestedNextVersion = data.current_revision;
                    }
                    document.getElementById('suggested-next-version').textContent = 'v' + suggestedNextVersion;

                    // Optionally auto-select the suggested type
                    revisionTypeSelect.value = suggestedType;
                    revisionTypeSelect.dispatchEvent(new Event('change'));
                } else {
                    alert('No changes detected');
                }
            } else {
                alert('Error detecting changes: ' + data.message);
            }
        })
        .catch(error => {
            changeDetectionStatus.style.display = 'none';
            console.error('Error:', error);
            alert('Error detecting changes');
        });
    });

    // View revision history
    document.getElementById('view-revision-history').addEventListener('click', function() {
        fetch('/motors/{{ motor.motor_id }}/revisions')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let historyHtml = '<div class="modal fade" id="revisionHistoryModal" tabindex="-1">' +
                        '<div class="modal-dialog modal-lg">' +
                        '<div class="modal-content">' +
                        '<div class="modal-header">' +
                        '<h5 class="modal-title">Revision History</h5>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                        '<p>Current Revision: <strong>v' + data.current_revision + '</strong></p>' +
                        '<table class="table table-striped">' +
                        '<thead><tr>' +
                        '<th>Version</th>' +
                        '<th>Type</th>' +
                        '<th>Motor Name</th>' +
                        '<th>HP</th>' +
                        '<th>Voltage</th>' +
                        '<th>Qty</th>' +
                        '<th>Changed By</th>' +
                        '<th>Date</th>' +
                        '</tr></thead><tbody>';

                    data.revisions.forEach(rev => {
                        const typeIcon = {'major': '🔴', 'minor': '🟡', 'overwrite': '🔵'}[rev.revision_type] || '';
                        historyHtml += '<tr>' +
                            '<td>v' + rev.revision_number + '</td>' +
                            '<td>' + typeIcon + ' ' + rev.revision_type + '</td>' +
                            '<td>' + rev.motor_name + '</td>' +
                            '<td>' + (rev.hp || 'N/A') + '</td>' +
                            '<td>' + rev.voltage + 'V</td>' +
                            '<td>' + rev.qty + '</td>' +
                            '<td>' + (rev.changed_by || 'Unknown') + '</td>' +
                            '<td>' + rev.created_at + '</td>' +
                            '</tr>';
                    });

                    historyHtml += '</tbody></table></div>' +
                        '<div class="modal-footer">' +
                        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>' +
                        '</div></div></div></div>';

                    // Remove existing modal if present
                    const existingModal = document.getElementById('revisionHistoryModal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    document.body.insertAdjacentHTML('beforeend', historyHtml);
                    const modal = new bootstrap.Modal(document.getElementById('revisionHistoryModal'));
                    modal.show();
                }
            });
    });
});
</script>
{% endblock %}