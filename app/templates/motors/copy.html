{% extends "base.html" %}
{% block title %}Copy Motors - {{ project.project_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Copy Motors to {{ project.project_name }}</h2>
                <div>
                    <a href="{{ url_for('motors.list_motors', project_id=project.project_id) }}" 
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Motors
                    </a>
                </div>
            </div>

            {% if other_projects %}
            <form method="POST" id="copyForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Select Source Project</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="source_project_id" class="form-label">Project:</label>
                            <select class="form-select" id="source_project_id" name="source_project_id" required onchange="loadProjectMotors()">
                                <option value="">Select a project...</option>
                                {% for proj in other_projects %}
                                <option value="{{ proj.project_id }}">{{ proj.project_name }} ({{ proj.client_name }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card mt-3" id="motorsCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            Select Motors to Copy
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="toggleAllMotors()">
                                Select All
                            </button>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="motorsContainer">
                            <!-- Motors will be loaded here -->
                        </div>
                        
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary" id="copyButton" disabled>
                                <i class="fas fa-copy"></i> Copy Selected Motors
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            {% else %}
            <div class="alert alert-info">
                <h4>No Other Projects Found</h4>
                <p>There are no other projects with motors to copy from. Create motors in other projects first, then you can copy them here.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let allMotorsSelected = false;

function loadProjectMotors() {
    const projectId = document.getElementById('source_project_id').value;
    const motorsCard = document.getElementById('motorsCard');
    const motorsContainer = document.getElementById('motorsContainer');
    const copyButton = document.getElementById('copyButton');
    
    if (!projectId) {
        motorsCard.style.display = 'none';
        copyButton.disabled = true;
        return;
    }
    
    // Show loading
    motorsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    motorsCard.style.display = 'block';
    
    fetch(`/motors/api/project_motors/${projectId}`)
        .then(response => response.json())
        .then(motors => {
            if (motors.length === 0) {
                motorsContainer.innerHTML = '<div class="alert alert-warning">No motors found in this project.</div>';
                copyButton.disabled = true;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped table-hover">';
            html += '<thead class="table-dark">';
            html += '<tr><th width="50"><input type="checkbox" id="selectAll" onchange="toggleAllMotors()"></th>';
            html += '<th>Name</th><th>Type</th><th>Location</th><th>HP</th><th>Voltage</th><th>Qty</th><th>Motor Amps</th><th>Total Amps</th></tr>';
            html += '</thead><tbody>';
            
            motors.forEach(motor => {
                html += `<tr>
                    <td><input type="checkbox" name="motor_ids" value="${motor.motor_id}" onchange="updateCopyButton()"></td>
                    <td><strong>${motor.motor_name}</strong></td>
                    <td><span class="badge ${motor.load_type === 'motor' ? 'bg-primary' : 'bg-info'}">${motor.load_type.charAt(0).toUpperCase() + motor.load_type.slice(1)}</span></td>
                    <td>${motor.location || '-'}</td>
                    <td>${motor.hp || '-'}</td>
                    <td>${motor.voltage}V</td>
                    <td>${motor.qty}</td>
                    <td>${motor.motor_amps.toFixed(1)}A</td>
                    <td>${motor.total_amps.toFixed(1)}A</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            motorsContainer.innerHTML = html;
            copyButton.disabled = true;
        })
        .catch(error => {
            console.error('Error loading motors:', error);
            motorsContainer.innerHTML = '<div class="alert alert-danger">Error loading motors. Please try again.</div>';
            copyButton.disabled = true;
        });
}

function toggleAllMotors() {
    const selectAll = document.getElementById('selectAll');
    const motorCheckboxes = document.querySelectorAll('input[name="motor_ids"]');
    
    if (selectAll && selectAll.checked !== undefined) {
        allMotorsSelected = selectAll.checked;
    } else {
        allMotorsSelected = !allMotorsSelected;
        if (selectAll) selectAll.checked = allMotorsSelected;
    }
    
    motorCheckboxes.forEach(checkbox => {
        checkbox.checked = allMotorsSelected;
    });
    
    updateCopyButton();
}

function updateCopyButton() {
    const selectedMotors = document.querySelectorAll('input[name="motor_ids"]:checked');
    const copyButton = document.getElementById('copyButton');
    const selectAll = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('input[name="motor_ids"]');
    
    copyButton.disabled = selectedMotors.length === 0;
    
    // Update select all checkbox state
    if (selectAll && allCheckboxes.length > 0) {
        if (selectedMotors.length === allCheckboxes.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else if (selectedMotors.length === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }
}

// Form submission confirmation
document.getElementById('copyForm').addEventListener('submit', function(e) {
    const selectedMotors = document.querySelectorAll('input[name="motor_ids"]:checked');
    const projectName = document.getElementById('source_project_id').selectedOptions[0].text;
    
    if (!confirm(`Are you sure you want to copy ${selectedMotors.length} motor(s) from "${projectName}" to this project?`)) {
        e.preventDefault();
    }
});
</script>
{% endblock %}