{% extends "base.html" %}

{% block title %}Apply Standard Assemblies{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-download"></i> Apply Standard Assemblies</h1>
        <p class="text-muted mb-0">Add standard assemblies to your project estimates</p>
    </div>
    <div>
        <a href="{{ url_for('standard_assemblies.list_assemblies') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Assemblies
        </a>
    </div>
</div>

<!-- Selection Panel -->
<div class="row">
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-crosshairs"></i> Target Selection
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="projectSelect" class="form-label">Project</label>
                    <select class="form-select" id="projectSelect">
                        <option value="">Select a project...</option>
                        {% for project in projects %}
                            <option value="{{ project.project_id }}" 
                                    {% if project.project_id == selected_project_id %}selected{% endif %}>
                                {{ project.project_name }} ({{ project.client_name }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="estimateSelect" class="form-label">Estimate</label>
                    <select class="form-select" id="estimateSelect" disabled>
                        {% if selected_estimate_id %}
                            {% for estimate in estimates %}
                                <option value="{{ estimate.estimate_id }}" 
                                        {% if estimate.estimate_id == selected_estimate_id %}selected{% endif %}>
                                    {{ estimate.estimate_name }} ({{ estimate.estimate_number }})
                                </option>
                            {% endfor %}
                        {% else %}
                            <option value="">Select a project first</option>
                        {% endif %}
                    </select>
                </div>
                
                <div id="estimateInfo" class="alert alert-info d-none">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong id="selectedEstimateName">-</strong>
                            <div class="small text-muted" id="selectedEstimateDetails">-</div>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted">Current Total</div>
                            <strong id="selectedEstimateTotal">$0.00</strong>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <!-- Applied Assemblies -->
                <div id="appliedAssemblies">
                    <h6 class="text-muted">Applied Assemblies</h6>
                    <div id="appliedAssembliesList" class="small">
                        <div class="text-muted text-center py-2">
                            No assemblies applied yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Standard Assemblies Grid -->
    <div class="col-lg-8">
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchAssemblies" 
                               placeholder="Search assemblies...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            {% set categories = assemblies | map(attribute='category') | map(attribute='name') | list | unique | sort %}
                            {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sortBy">
                            <option value="name">Sort by Name</option>
                            <option value="category">Sort by Category</option>
                            <option value="cost">Sort by Cost</option>
                            <option value="components">Sort by Components</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Assemblies Grid -->
        <div id="assembliesGrid" class="row">
            {% for assembly in assemblies %}
            <div class="col-lg-6 col-xl-4 mb-4 assembly-card"
                 id="assembly-card-{{ assembly.standard_assembly_id }}"
                 data-category="{{ assembly.category.name if assembly.category else '' }}"
                 data-name="{{ assembly.name.lower() }}"
                 data-cost="{{ assembly.total_cost }}"
                 data-components="{{ assembly.component_count }}"
                 data-assembly-id="{{ assembly.standard_assembly_id }}">
                <div class="card h-100">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h6 class="card-title mb-1">{{ assembly.name }}</h6>
                                <small class="text-muted">{{ assembly.category.name }}</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <label class="form-label mb-0 me-2 text-muted small">Version:</label>
                            <select class="form-select form-select-sm assembly-version-select" 
                                    style="width: 200px;"
                                    data-assembly-id="{{ assembly.standard_assembly_id }}"
                                    data-current-version="{{ assembly.version }}"
                                    data-card-container="assembly-card-{{ assembly.standard_assembly_id }}">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <p class="card-text small text-muted mb-3">
                            {{ assembly.description[:80] }}{% if assembly.description and assembly.description|length > 80 %}...{% endif %}
                        </p>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="border-end">
                                    <div class="h6 text-primary mb-0 component-count" 
                                         data-assembly-id="{{ assembly.standard_assembly_id }}">{{ assembly.component_count }}</div>
                                    <small class="text-muted">Components</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="h6 text-success mb-0 total-cost" 
                                     data-assembly-id="{{ assembly.standard_assembly_id }}">${{ "{:,.2f}".format(assembly.total_cost) }}</div>
                                <small class="text-muted">Total Cost</small>
                            </div>
                        </div>
                        
                        <!-- Preview Components -->
                        <div class="mb-3 key-components" data-assembly-id="{{ assembly.standard_assembly_id }}">
                            <div class="small text-muted mb-1">Key Components:</div>
                            {% for component in assembly.components[:3] %}
                                <div class="small text-truncate">
                                    â€¢ {{ component.part_number }} ({{ component.quantity }} {{ component.unit_of_measure }})
                                </div>
                            {% endfor %}
                            {% if assembly.components|length > 3 %}
                                <div class="small text-muted">... and {{ assembly.components|length - 3 }} more</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success apply-assembly-btn" 
                                    data-assembly-id="{{ assembly.standard_assembly_id }}"
                                    data-assembly-name="{{ assembly.name }}"
                                    data-assembly-cost="{{ assembly.total_cost }}"
                                    disabled>
                                <i class="fas fa-download"></i> Apply Assembly
                            </button>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('standard_assemblies.view_assembly', assembly_id=assembly.standard_assembly_id) }}" 
                                   class="btn btn-outline-info" target="_blank">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <button class="btn btn-outline-secondary" 
                                        onclick="previewAssembly({{ assembly.standard_assembly_id }})">
                                    <i class="fas fa-list"></i> Preview
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if not assemblies %}
            <div class="text-center py-5">
                <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Standard Assemblies Available</h4>
                <p class="text-muted">Create standard assemblies first before applying them to estimates.</p>
                <a href="{{ url_for('standard_assemblies.create_assembly') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Standard Assembly
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assembly Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin"></i> Loading preview...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="applyFromPreviewBtn" disabled>
                    <i class="fas fa-download"></i> Apply Assembly
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Apply Assembly:</strong> <span id="confirmAssemblyName">-</span><br>
                    <strong>To Estimate:</strong> <span id="confirmEstimateName">-</span><br>
                    <strong>Components to Add:</strong> <span id="confirmComponentCount">0</span><br>
                    <strong>Base Cost per Assembly:</strong> <span id="confirmAssemblyCost">$0.00</span><br>
                    <strong>Total Cost:</strong> <span id="confirmTotalCost">$0.00</span>
                </div>
                
                <div class="mb-3">
                    <label for="assemblyQuantity" class="form-label">Number of Assemblies *</label>
                    <input type="number" class="form-control" id="assemblyQuantity" min="1" step="1" value="1" required>
                    <div class="form-text">Specify how many of this standard assembly to add. Component quantities will be multiplied accordingly.</div>
                </div>
                
                <p>This will add all components from the standard assembly to your estimate. You can modify quantities and details after application.</p>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmUnderstand">
                    <label class="form-check-label" for="confirmUnderstand">
                        I understand this will add components to the estimate
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="finalApplyBtn" disabled>
                    <i class="fas fa-download"></i> Apply Assembly
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let selectedProjectId = {{ selected_project_id or 'null' }};
let selectedEstimateId = {{ selected_estimate_id or 'null' }};
let currentAssemblyForApply = null;
let appliedAssemblies = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Apply assemblies page loaded');
    console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
    
    setupEventHandlers();
    loadAssemblyVersions();
    
    // Initialize based on URL parameters
    if (selectedProjectId) {
        loadEstimatesForProject(selectedProjectId);
    }
    
    if (selectedEstimateId) {
        enableApplyButtons();
        loadEstimateInfo(selectedEstimateId);
    }
    
    setupFiltering();
});

function setupEventHandlers() {
    // Project selection
    document.getElementById('projectSelect').addEventListener('change', function() {
        selectedProjectId = this.value ? parseInt(this.value) : null;
        selectedEstimateId = null;
        
        if (selectedProjectId) {
            loadEstimatesForProject(selectedProjectId);
        } else {
            const estimateSelect = document.getElementById('estimateSelect');
            estimateSelect.innerHTML = '<option value="">Select a project first</option>';
            estimateSelect.disabled = true;
            disableApplyButtons();
            hideEstimateInfo();
        }
    });
    
    // Estimate selection
    document.getElementById('estimateSelect').addEventListener('change', function() {
        // Skip change event if we're rebuilding the dropdown
        if (window.rebuildingDropdown) {
            console.log('Ignoring change event during dropdown rebuild');
            return;
        }
        
        console.log('=== ESTIMATE SELECT CHANGED ===');
        console.log('Value:', this.value, 'Selected index:', this.selectedIndex);
        console.log('Options count:', this.options.length);
        console.log('Global selectedEstimateId:', selectedEstimateId);
        selectedEstimateId = this.value ? parseInt(this.value) : null;
        
        if (selectedEstimateId) {
            console.log('Valid estimate selected:', selectedEstimateId, '- SHOWING panel');
            enableApplyButtons();
            loadEstimateInfo(selectedEstimateId);
        } else {
            console.log('No estimate selected - HIDING panel');
            disableApplyButtons();
            hideEstimateInfo();
        }
        console.log('=== END ESTIMATE SELECT CHANGED ===');
    });
    
    // Apply buttons
    document.querySelectorAll('.apply-assembly-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const assemblyId = parseInt(this.dataset.assemblyId);
            const assemblyName = this.dataset.assemblyName;
            const assemblyCost = parseFloat(this.dataset.assemblyCost);
            
            showConfirmationModal(assemblyId, assemblyName, assemblyCost);
        });
    });
    
    // Confirmation modal
    document.getElementById('confirmUnderstand').addEventListener('change', function() {
        document.getElementById('finalApplyBtn').disabled = !this.checked;
    });
    
    // Assembly quantity input
    document.getElementById('assemblyQuantity').addEventListener('input', function() {
        updateTotalCost();
    });
    
    document.getElementById('finalApplyBtn').addEventListener('click', applyAssemblyToEstimate);
    
    // Modal close buttons
    document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.closest('.modal').id;
            if (modalId === 'confirmationModal') {
                closeConfirmationModal();
            }
        });
    });
    
    // Search and filters
    document.getElementById('searchAssemblies').addEventListener('input', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('sortBy').addEventListener('change', applySorting);
}

function loadEstimatesForProject(projectId) {
    fetch(`/standard_assemblies/api/estimates/${projectId}`)
        .then(response => response.json())
        .then(estimates => {
            const select = document.getElementById('estimateSelect');
            
            // Temporarily disable change event handling during rebuild by setting a flag
            window.rebuildingDropdown = true;
            
            console.log('Rebuilding estimate dropdown for project:', projectId);
            select.innerHTML = '<option value="">Select an estimate...</option>';
            
            if (estimates.length === 0) {
                select.innerHTML = '<option value="">No estimates found</option>';
                select.disabled = true;
                disableApplyButtons();
            } else {
                estimates.forEach(estimate => {
                    const option = document.createElement('option');
                    option.value = estimate.estimate_id;
                    option.textContent = `${estimate.estimate_name} (${estimate.estimate_number})`;
                    if (estimate.estimate_id === selectedEstimateId) {
                        option.selected = true;
                        console.log('Pre-selected estimate option:', estimate.estimate_id);
                    }
                    select.appendChild(option);
                });
                select.disabled = false;
                
                // If there's a pre-selected estimate, load its info
                if (selectedEstimateId) {
                    console.log('Re-loading info for pre-selected estimate:', selectedEstimateId);
                    enableApplyButtons();
                    loadEstimateInfo(selectedEstimateId);
                }
            }
            
            // Re-enable change event handling
            window.rebuildingDropdown = false;
            console.log('Estimate dropdown rebuild complete');
        })
        .catch(error => {
            console.error('Error loading estimates:', error);
            showToast('error', 'Error', 'Failed to load estimates');
        });
}

function loadEstimateInfo(estimateId) {
    if (!estimateId) {
        console.log('No estimateId provided to loadEstimateInfo');
        return;
    }
    
    // Wait for DOM to be ready if needed
    setTimeout(() => {
        const estimateSelect = document.getElementById('estimateSelect');
        if (!estimateSelect) {
            console.log('Estimate select not found');
            return;
        }
        
        // Find the option with the matching estimate ID, not just the currently selected one
        let targetOption = null;
        for (let i = 0; i < estimateSelect.options.length; i++) {
            if (parseInt(estimateSelect.options[i].value) === parseInt(estimateId)) {
                targetOption = estimateSelect.options[i];
                break;
            }
        }
        
        if (!targetOption || !targetOption.value) {
            console.log(`No option found for estimate ID ${estimateId}`);
            return;
        }
        
        const selectedEstimateName = document.getElementById('selectedEstimateName');
        const selectedEstimateDetails = document.getElementById('selectedEstimateDetails');
        const selectedEstimateTotal = document.getElementById('selectedEstimateTotal');
        const estimateInfo = document.getElementById('estimateInfo');
        
        if (selectedEstimateName && selectedEstimateDetails && selectedEstimateTotal && estimateInfo) {
            selectedEstimateName.textContent = targetOption.textContent;
            selectedEstimateDetails.textContent = 'Click apply to add assemblies';
            selectedEstimateTotal.textContent = '$0.00'; // Would load actual total
            estimateInfo.classList.remove('d-none');
            console.log(`âœ… SHOWING ESTIMATE INFO PANEL âœ…`);
            console.log(`Estimate info loaded successfully for ID ${estimateId}: ${targetOption.textContent}`);
            
            // Force the element to stay visible by overriding any attempts to hide it
            estimateInfo.style.display = 'block !important';
            estimateInfo.style.visibility = 'visible !important';
            estimateInfo.style.opacity = '1 !important';
            
            // Add a flag to identify this as a protected element
            estimateInfo.dataset.protected = 'true';
            
            // Set up a MutationObserver to track ANY changes to the element
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    console.log('ðŸ” MUTATION OBSERVER: Element changed!', {
                        type: mutation.type,
                        attributeName: mutation.attributeName,
                        oldValue: mutation.oldValue,
                        newValue: mutation.target.getAttribute(mutation.attributeName)
                    });
                    
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (estimateInfo.classList.contains('d-none')) {
                            console.log('ðŸ” d-none class was added!');
                            console.log('Stack trace:', new Error().stack);
                        }
                    }
                    
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        console.log('ðŸŽ¨ Style attribute changed!');
                        console.log('New style:', estimateInfo.style.cssText);
                        console.log('Computed style display:', window.getComputedStyle(estimateInfo).display);
                        console.log('Stack trace:', new Error().stack);
                    }
                });
            });
            
            observer.observe(estimateInfo, { 
                attributes: true, 
                attributeOldValue: true,
                attributeFilter: ['class', 'style', 'hidden'] 
            });
            
            // Add periodic checks to see what's happening to the element
            const checkInterval = setInterval(() => {
                const currentElement = document.getElementById('estimateInfo');
                if (!currentElement) {
                    console.log('âŒ Element no longer exists in DOM!');
                    clearInterval(checkInterval);
                    return;
                }
                
                const isVisible = !currentElement.classList.contains('d-none');
                const computedStyle = window.getComputedStyle(currentElement);
                const displayValue = computedStyle.display;
                const visibilityValue = computedStyle.visibility;
                const opacityValue = computedStyle.opacity;
                
                const rect = currentElement.getBoundingClientRect();
                const parent = currentElement.parentElement;
                
                console.log('ðŸ” Element status check:', {
                    hasElement: !!currentElement,
                    hasDnoneClass: currentElement.classList.contains('d-none'),
                    display: displayValue,
                    visibility: visibilityValue,
                    opacity: opacityValue,
                    offsetHeight: currentElement.offsetHeight,
                    offsetWidth: currentElement.offsetWidth,
                    boundingRect: {
                        top: rect.top,
                        left: rect.left,
                        width: rect.width,
                        height: rect.height,
                        bottom: rect.bottom,
                        right: rect.right
                    },
                    parentElement: parent ? parent.tagName + (parent.id ? '#' + parent.id : '') : 'null',
                    parentDisplay: parent ? window.getComputedStyle(parent).display : 'null'
                });
                
                if (displayValue === 'none' || visibilityValue === 'hidden' || opacityValue === '0' || currentElement.offsetHeight === 0) {
                    console.log('ðŸš¨ Element is effectively hidden but not by d-none class!');
                }
            }, 1000);
            
            // Stop checking after 10 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
            }, 10000);
            
            // Stop observing after 10 seconds
            setTimeout(() => {
                observer.disconnect();
                console.log('Stopped observing panel changes');
            }, 10000);
        } else {
            console.log('Some estimate info elements not yet available');
        }
    }, 100);  // Increased delay to ensure dropdown is fully populated
}

function hideEstimateInfo() {
    console.log('ðŸš¨ HIDING ESTIMATE INFO PANEL ðŸš¨');
    console.log('hideEstimateInfo() called from:', new Error().stack);
    const estimateInfo = document.getElementById('estimateInfo');
    if (estimateInfo) {
        estimateInfo.classList.add('d-none');
        console.log('âŒ Estimate info panel hidden');
    }
}

function enableApplyButtons() {
    document.querySelectorAll('.apply-assembly-btn').forEach(btn => {
        btn.disabled = false;
    });
}

function disableApplyButtons() {
    document.querySelectorAll('.apply-assembly-btn').forEach(btn => {
        btn.disabled = true;
    });
}



function showConfirmationModal(assemblyId, assemblyName, assemblyCost) {
    currentAssemblyForApply = {
        id: assemblyId,
        name: assemblyName,
        cost: assemblyCost
    };
    
    const estimateSelect = document.getElementById('estimateSelect');
    const selectedOption = estimateSelect ? estimateSelect.options[estimateSelect.selectedIndex] : null;
    
    if (!selectedOption || !selectedOption.value) {
        showToast('error', 'Error', 'Please select a valid estimate first.');
        return;
    }
    
    // Simple direct approach - just try to set the values and show modal
    console.log('Attempting to show confirmation modal...');
    
    const confirmAssemblyNameEl = document.getElementById('confirmAssemblyName');
    const confirmEstimateNameEl = document.getElementById('confirmEstimateName');
    const confirmComponentCountEl = document.getElementById('confirmComponentCount');
    const confirmAssemblyCostEl = document.getElementById('confirmAssemblyCost');
    const confirmTotalCostEl = document.getElementById('confirmTotalCost');
    
    // Set values directly if elements exist
    if (confirmAssemblyNameEl) confirmAssemblyNameEl.textContent = assemblyName;
    if (confirmEstimateNameEl) confirmEstimateNameEl.textContent = selectedOption.textContent;
    if (confirmAssemblyCostEl) confirmAssemblyCostEl.textContent = `$${assemblyCost.toFixed(2)}`;
    if (confirmTotalCostEl) confirmTotalCostEl.textContent = `$${assemblyCost.toFixed(2)}`;
    if (confirmComponentCountEl) confirmComponentCountEl.textContent = 'Loading...';
    
    // Reset form elements
    const quantityInput = document.getElementById('assemblyQuantity');
    const confirmCheckbox = document.getElementById('confirmUnderstand');
    const finalApplyBtn = document.getElementById('finalApplyBtn');
    
    if (quantityInput) quantityInput.value = 1;
    if (confirmCheckbox) confirmCheckbox.checked = false;
    if (finalApplyBtn) finalApplyBtn.disabled = true;
    
    // Load component count
    fetch(`/standard_assemblies/api/${assemblyId}/components`)
        .then(response => response.json())
        .then(components => {
            if (confirmComponentCountEl) {
                confirmComponentCountEl.textContent = components.length;
            }
        })
        .catch(error => {
            console.error('Error loading component count:', error);
            if (confirmComponentCountEl) {
                confirmComponentCountEl.textContent = 'Error loading';
            }
        });
    
    // Show modal using Bootstrap
    const confirmationModal = document.getElementById('confirmationModal');
    if (confirmationModal && typeof bootstrap !== 'undefined') {
        try {
            const modal = new bootstrap.Modal(confirmationModal);
            modal.show();
            console.log('Modal shown successfully');
        } catch (error) {
            console.error('Error showing modal:', error);
            showToast('error', 'Error', 'Failed to open confirmation modal.');
        }
    } else {
        console.error('Modal element or Bootstrap not available');
        showToast('error', 'Error', 'Modal not available.');
    }
}

function setupAndShowModal(confirmAssemblyNameEl, confirmEstimateNameEl, confirmComponentCountEl, 
                          confirmAssemblyCostEl, confirmTotalCostEl, selectedOption) {
    
    if (!selectedOption || !selectedOption.textContent) {
        showToast('error', 'Error', 'Please select a valid estimate first.');
        return false;
    }
    
    confirmAssemblyNameEl.textContent = currentAssemblyForApply.name;
    confirmEstimateNameEl.textContent = selectedOption.textContent;
    confirmComponentCountEl.textContent = 'Loading...';
    confirmAssemblyCostEl.textContent = `$${currentAssemblyForApply.cost.toFixed(2)}`;
    
    // Reset quantity and confirmation
    const quantityInput = document.getElementById('assemblyQuantity');
    if (quantityInput) {
        quantityInput.value = 1;
    }
    
    const confirmCheckbox = document.getElementById('confirmUnderstand');
    if (confirmCheckbox) {
        confirmCheckbox.checked = false;
    }
    
    const finalApplyBtn = document.getElementById('finalApplyBtn');
    if (finalApplyBtn) {
        finalApplyBtn.disabled = true;
    }
    
    // Update total cost initially
    updateTotalCost();
    
    // Load component count
    fetch(`/standard_assemblies/api/${currentAssemblyForApply.id}/components`)
        .then(response => response.json())
        .then(components => {
            if (confirmComponentCountEl) {
                confirmComponentCountEl.textContent = components.length;
            }
        })
        .catch(error => {
            console.error('Error loading component count:', error);
            if (confirmComponentCountEl) {
                confirmComponentCountEl.textContent = 'Error loading';
            }
        });
    
    // Show modal
    try {
        const modalElement = document.getElementById('confirmationModal');
        if (!modalElement) {
            throw new Error('Confirmation modal element not found');
        }
        
        // Check if bootstrap is available
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap is not loaded');
            // Fallback - show modal manually
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            modalElement.setAttribute('aria-modal', 'true');
            modalElement.setAttribute('role', 'dialog');
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'modal-backdrop-fallback';
            document.body.appendChild(backdrop);
            
            return true;
        }
        
        try {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } catch (modalError) {
            console.error('Bootstrap modal initialization failed:', modalError);
            // Manual fallback
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            modalElement.setAttribute('aria-modal', 'true');
            modalElement.setAttribute('role', 'dialog');
            
            // Add backdrop
            if (!document.getElementById('modal-backdrop-fallback')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.id = 'modal-backdrop-fallback';
                document.body.appendChild(backdrop);
                document.body.classList.add('modal-open');
            }
        }
        
        return true; // Success
    } catch (error) {
        console.error('Error showing modal:', error);
        showToast('error', 'Error', 'Failed to open confirmation modal. Please try again.');
        return false;
    }
}

function updateTotalCost() {
    if (!currentAssemblyForApply) return;
    
    const quantityInput = document.getElementById('assemblyQuantity');
    const confirmTotalCostEl = document.getElementById('confirmTotalCost');
    
    if (!quantityInput || !confirmTotalCostEl) return;
    
    const quantity = parseInt(quantityInput.value) || 1;
    const totalCost = currentAssemblyForApply.cost * quantity;
    
    confirmTotalCostEl.textContent = `$${totalCost.toFixed(2)}`;
}

function closeConfirmationModal() {
    try {
        const modalElement = document.getElementById('confirmationModal');
        if (!modalElement) {
            console.error('Modal element not found for closing');
            return;
        }
        
        if (typeof bootstrap !== 'undefined') {
            try {
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                } else {
                    // Try to create and immediately hide if no instance exists
                    const modal = new bootstrap.Modal(modalElement);
                    modal.hide();
                }
            } catch (bootstrapError) {
                console.error('Bootstrap modal close failed, using fallback:', bootstrapError);
                // Fall through to manual close
            }
        }
        
        // Always do manual cleanup as well (in case Bootstrap failed)
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.removeAttribute('aria-modal');
        modalElement.removeAttribute('role');
        
        // Remove any fallback backdrops
        const fallbackBackdrop = document.getElementById('modal-backdrop-fallback');
        if (fallbackBackdrop) {
            fallbackBackdrop.remove();
        }
        
        // Remove any Bootstrap backdrops that might be stuck
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });
        
        // Ensure body class is cleaned up
        document.body.classList.remove('modal-open');
        
    } catch (error) {
        console.error('Error closing modal:', error);
        // Force close as last resort
        const modalElement = document.getElementById('confirmationModal');
        if (modalElement) {
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
        }
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    }
}

function applyAssemblyToEstimate() {
    if (!currentAssemblyForApply || !selectedEstimateId) return;
    
    const quantityInput = document.getElementById('assemblyQuantity');
    const quantity = parseInt(quantityInput.value) || 1;
    
    if (quantity < 1) {
        showToast('error', 'Error', 'Quantity must be at least 1');
        return;
    }
    
    const btn = document.getElementById('finalApplyBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
    btn.disabled = true;
    
    console.log('Applying assembly:', currentAssemblyForApply.id, 'to estimate:', selectedEstimateId, 'with quantity:', quantity);
    
    const requestUrl = `/standard_assemblies/apply/${currentAssemblyForApply.id}/to/${selectedEstimateId}`;
    const requestBody = JSON.stringify({ quantity: quantity });
    
    console.log('Request URL:', requestUrl);
    console.log('Request body:', requestBody);
    console.log('Current assembly data:', currentAssemblyForApply);
    
    fetch(requestUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: requestBody
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        console.log('Response content-type:', response.headers.get('content-type'));
        
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response body:', text);
                console.error('Response status:', response.status);
                console.error('Response status text:', response.statusText);
                
                // Try to parse as JSON for better error handling
                try {
                    const errorData = JSON.parse(text);
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                } catch (parseError) {
                    // If not JSON, show the raw text
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}${text.length > 200 ? '...' : ''}`);
                }
            });
        }
        
        return response.text().then(text => {
            console.log('Raw response text:', text);
            try {
                return JSON.parse(text);
            } catch (parseError) {
                console.error('Failed to parse JSON response:', parseError);
                console.error('Response text was:', text);
                throw new Error(`Invalid JSON response: ${parseError.message}. Response: ${text.substring(0, 100)}${text.length > 100 ? '...' : ''}`);
            }
        });
    })
    .then(data => {
        if (data.success) {
            // Close modal
            closeConfirmationModal();
            
            // Add to applied list
            addToAppliedList(currentAssemblyForApply);
            
            // Show success message
            showToast('success', 'Success', data.message);

            // Ask if user wants to view the estimate
            setTimeout(() => {
                if (confirm('Assembly applied successfully! Would you like to view the estimate?')) {
                    window.location.href = data.estimate_url;
                }
            }, 1000);
            
        } else {
            showToast('error', 'Error', data.error);
        }
    })
    .catch(error => {
        console.error('Error applying assembly:', error);
        console.error('Error stack:', error.stack);
        
        // Show more detailed error message to user
        let errorMessage = 'Failed to apply assembly';
        if (error.message) {
            if (error.message.includes('Invalid JSON response')) {
                errorMessage = 'Server returned invalid response. Please try again or contact support.';
            } else if (error.message.includes('HTTP 400')) {
                errorMessage = 'Invalid request. Please check your selection and try again.';
            } else if (error.message.includes('HTTP 404')) {
                errorMessage = 'Assembly or estimate not found. Please refresh the page and try again.';
            } else if (error.message.includes('HTTP 500')) {
                errorMessage = 'Server error occurred. Please try again or contact support.';
            } else {
                errorMessage = `Error: ${error.message}`;
            }
        }
        
        showToast('error', 'Apply Failed', errorMessage);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        document.getElementById('confirmUnderstand').checked = false;
    });
}

function addToAppliedList(assembly) {
    appliedAssemblies.push(assembly);
    updateAppliedList();
}

function updateAppliedList() {
    const container = document.getElementById('appliedAssembliesList');
    
    if (appliedAssemblies.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-2">No assemblies applied yet</div>';
        return;
    }
    
    const totalCost = appliedAssemblies.reduce((sum, assembly) => sum + assembly.cost, 0);
    
    container.innerHTML = `
        ${appliedAssemblies.map(assembly => `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="text-truncate">
                    <i class="fas fa-check text-success"></i> ${assembly.name}
                </div>
                <div class="text-success">$${assembly.cost.toFixed(2)}</div>
            </div>
        `).join('')}
        <hr class="my-2">
        <div class="d-flex justify-content-between">
            <strong>Total Applied:</strong>
            <strong class="text-success">$${totalCost.toFixed(2)}</strong>
        </div>
    `;
}

function previewAssembly(assemblyId) {
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
    
    document.getElementById('applyFromPreviewBtn').dataset.assemblyId = assemblyId;
    document.getElementById('applyFromPreviewBtn').disabled = !selectedEstimateId;
    
    fetch(`/standard_assemblies/api/${assemblyId}/components`)
        .then(response => response.json())
        .then(components => {
            renderPreview(components, assemblyId);
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            document.getElementById('previewContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Failed to load assembly preview.
                </div>
            `;
        });
}

function renderPreview(components, assemblyId) {
    const total = components.reduce((sum, comp) => sum + comp.total_price, 0);
    
    document.getElementById('previewContent').innerHTML = `
        <div class="mb-3">
            <h6>Components (${components.length}):</h6>
        </div>
        <div class="table-responsive" style="max-height: 400px;">
            <table class="table table-sm">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>Part Number</th>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>UOM</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${components.map(comp => `
                        <tr>
                            <td><strong>${comp.part_number}</strong></td>
                            <td>
                                ${comp.component_name}
                                ${comp.notes ? `<br><small class="text-muted">${comp.notes}</small>` : ''}
                            </td>
                            <td>${comp.quantity}</td>
                            <td>${comp.unit_of_measure}</td>
                            <td class="text-success">$${comp.unit_price.toFixed(2)}</td>
                            <td><strong class="text-success">$${comp.total_price.toFixed(2)}</strong></td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="5">Total:</th>
                        <th class="text-success">$${total.toFixed(2)}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
}

function setupFiltering() {
    // Initial state
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchAssemblies').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    
    document.querySelectorAll('.assembly-card').forEach(card => {
        const name = card.dataset.name;
        const category = card.dataset.category;
        
        const matchesSearch = !searchTerm || name.includes(searchTerm);
        const matchesCategory = !categoryFilter || category === categoryFilter;
        
        if (matchesSearch && matchesCategory) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function applySorting() {
    const sortBy = document.getElementById('sortBy').value;
    const container = document.getElementById('assembliesGrid');
    const cards = Array.from(container.children);
    
    cards.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.dataset.name.localeCompare(b.dataset.name);
            case 'category':
                return a.dataset.category.localeCompare(b.dataset.category);
            case 'cost':
                return parseFloat(b.dataset.cost) - parseFloat(a.dataset.cost);
            case 'components':
                return parseInt(b.dataset.components) - parseInt(a.dataset.components);
            default:
                return 0;
        }
    });
    
    cards.forEach(card => container.appendChild(card));
}

function clearFilters() {
    document.getElementById('searchAssemblies').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('sortBy').value = 'name';
    applyFilters();
    applySorting();
}

function showToast(type, title, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style = 'top: 20px; right: 20px; z-index: 1050; max-width: 400px;';
    toast.innerHTML = `
        <strong>${title}!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 5000);
}

// Assembly Version Management Functions
function loadAssemblyVersions() {
    document.querySelectorAll('.assembly-version-select').forEach(select => {
        const assemblyId = select.dataset.assemblyId;
        const currentVersion = select.dataset.currentVersion;
        
        // Load available versions
        fetch(`/standard_assemblies/${assemblyId}/versions`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateVersionDropdown(select, data.versions, currentVersion);
                    
                    // Add change event listener
                    select.addEventListener('change', function() {
                        const selectedVersion = this.value;
                        loadVersionComponentsForCard(selectedVersion, assemblyId);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading assembly versions:', error);
            });
    });
}

function populateVersionDropdown(select, versions, currentVersion) {
    select.innerHTML = '';
    
    versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version.version;
        
        // Concatenate version number with comment/notes
        let displayText = `v${version.version}`;
        if (version.version_notes && version.version_notes.trim()) {
            displayText += ` - ${version.version_notes.trim()}`;
        }
        
        if (version.is_active) {
            displayText += ' (Active)';
        }
        
        option.textContent = displayText;
        option.dataset.assemblyId = version.standard_assembly_id; // Store specific assembly ID for this version
        if (version.version === currentVersion) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function loadVersionComponentsForCard(selectedVersion, baseAssemblyId) {
    // First get the versions to find the specific assembly ID for the selected version
    fetch(`/standard_assemblies/${baseAssemblyId}/versions`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const selectedVersionData = data.versions.find(v => v.version === selectedVersion);
                if (selectedVersionData) {
                    // Now get the components for this specific version
                    return fetch(`/standard_assemblies/api/${selectedVersionData.standard_assembly_id}/components`);
                } else {
                    throw new Error('Selected version not found');
                }
            } else {
                throw new Error('Failed to load version information');
            }
        })
        .then(response => response.json())
        .then(components => {
            updateAssemblyCard(baseAssemblyId, components, selectedVersion);
        })
        .catch(error => {
            console.error('Error loading version components:', error);
            showToast('error', 'Error', 'Failed to load components for selected version');
        });
}

function updateAssemblyCard(assemblyId, components, selectedVersion) {
    const componentCount = components ? components.length : 0;
    const totalCost = components ? components.reduce((sum, comp) => sum + comp.total_price, 0) : 0;
    
    // Update component count
    const componentCountElement = document.querySelector(`.component-count[data-assembly-id="${assemblyId}"]`);
    if (componentCountElement) {
        componentCountElement.textContent = componentCount;
    }
    
    // Update total cost
    const totalCostElement = document.querySelector(`.total-cost[data-assembly-id="${assemblyId}"]`);
    if (totalCostElement) {
        totalCostElement.textContent = `$${totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    // Update key components preview
    const keyComponentsElement = document.querySelector(`.key-components[data-assembly-id="${assemblyId}"]`);
    if (keyComponentsElement) {
        if (!components || components.length === 0) {
            keyComponentsElement.innerHTML = `
                <div class="small text-muted mb-1">Key Components:</div>
                <div class="small text-muted">No components in this version</div>
            `;
        } else {
            const preview = components.slice(0, 3);
            const remaining = Math.max(0, components.length - 3);
            
            keyComponentsElement.innerHTML = `
                <div class="small text-muted mb-1">Key Components:</div>
                ${preview.map(component => 
                    `<div class="small text-truncate">â€¢ ${component.part_number || 'N/A'} (${component.quantity} ${component.unit_of_measure})</div>`
                ).join('')}
                ${remaining > 0 ? `<div class="small text-muted">... and ${remaining} more</div>` : ''}
            `;
        }
    }
    
    // Update the card's data attributes for filtering/sorting
    const card = document.getElementById(`assembly-card-${assemblyId}`);
    if (card) {
        card.dataset.cost = totalCost;
        card.dataset.components = componentCount;
    }
    
    // Update apply button data
    const applyButton = document.querySelector(`[data-assembly-id="${assemblyId}"].apply-assembly-btn`);
    if (applyButton) {
        applyButton.dataset.assemblyCost = totalCost;
        
        // Update the assembly ID to point to the specific version assembly ID
        const versionSelect = document.querySelector(`.assembly-version-select[data-assembly-id="${assemblyId}"]`);
        if (versionSelect) {
            const selectedOption = versionSelect.options[versionSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.assemblyId) {
                applyButton.dataset.assemblyId = selectedOption.dataset.assemblyId;
            }
        }
    }
}
</script>
{% endblock %}