{% extends "base.html" %}

{% block title %}Manage Hours - {{ estimate.estimate_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">Manage Labor Hours</h5>
                    <small class="text-muted">{{ estimate.estimate_name }} | Project: {{ estimate.project.project_name }}</small>
                </div>
                <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Estimate
                </a>
            </div>
            
            <div class="card-body">
                {% if assemblies %}
                <form method="POST" action="{{ url_for('assemblies.update_hours', estimate_id=estimate.estimate_id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">Assembly Name</th>
                                    <th style="width: 12%" class="text-center">Engineering<br><small class="text-muted">$145/hr</small></th>
                                    <th style="width: 12%" class="text-center">Panel Shop<br><small class="text-muted">$125/hr</small></th>
                                    <th style="width: 12%" class="text-center">Machine Assembly<br><small class="text-muted">$125/hr</small></th>
                                    <th style="width: 15%" class="text-center">Total Labor Cost</th>
                                    <th style="width: 12%">Estimated By</th>
                                    <th style="width: 12%">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assembly in assemblies %}
                                <tr>
                                    <td>
                                        <strong>{{ assembly.assembly_name }}</strong>
                                        {% if assembly.description %}
                                            <br><small class="text-muted">{{ assembly.description }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               name="engineering_hours_{{ assembly.assembly_id }}" 
                                               value="{{ assembly.engineering_hours or 0 }}"
                                               step="0.25" min="0" placeholder="0.0"
                                               onchange="updateCosts({{ assembly.assembly_id }})">
                                        <small class="text-primary d-block mt-1" id="eng_cost_{{ assembly.assembly_id }}">
                                            ${{ "{:,.2f}".format(assembly.calculated_engineering_cost) }}
                                        </small>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               name="panel_shop_hours_{{ assembly.assembly_id }}" 
                                               value="{{ assembly.panel_shop_hours or 0 }}"
                                               step="0.25" min="0" placeholder="0.0"
                                               onchange="updateCosts({{ assembly.assembly_id }})">
                                        <small class="text-warning d-block mt-1" id="panel_cost_{{ assembly.assembly_id }}">
                                            ${{ "{:,.2f}".format(assembly.calculated_panel_shop_cost) }}
                                        </small>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               name="machine_assembly_hours_{{ assembly.assembly_id }}" 
                                               value="{{ assembly.machine_assembly_hours or 0 }}"
                                               step="0.25" min="0" placeholder="0.0"
                                               onchange="updateCosts({{ assembly.assembly_id }})">
                                        <small class="text-success d-block mt-1" id="machine_cost_{{ assembly.assembly_id }}">
                                            ${{ "{:,.2f}".format(assembly.calculated_machine_assembly_cost) }}
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <strong class="text-info" id="total_labor_{{ assembly.assembly_id }}">
                                            ${{ "{:,.2f}".format(assembly.total_labor_cost) }}
                                        </strong>
                                        <br><small class="text-muted" id="total_hours_{{ assembly.assembly_id }}">
                                            {{ "{:.2f}".format(assembly.total_hours) }} hrs
                                        </small>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" 
                                               name="estimated_by_{{ assembly.assembly_id }}" 
                                               value="{{ assembly.estimated_by or '' }}"
                                               placeholder="Estimator">
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" 
                                                name="time_estimate_notes_{{ assembly.assembly_id }}" 
                                                rows="2" placeholder="Notes...">{{ assembly.time_estimate_notes or '' }}</textarea>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th>Totals:</th>
                                    <th class="text-center">
                                        <span class="text-primary">{{ "{:.2f}".format(estimate.total_engineering_hours) }} hrs</span>
                                        <br><small class="text-primary">${{ "{:,.2f}".format(estimate.total_engineering_cost) }}</small>
                                    </th>
                                    <th class="text-center">
                                        <span class="text-warning">{{ "{:.2f}".format(estimate.total_panel_shop_hours) }} hrs</span>
                                        <br><small class="text-warning">${{ "{:,.2f}".format(estimate.total_panel_shop_cost) }}</small>
                                    </th>
                                    <th class="text-center">
                                        <span class="text-success">{{ "{:.2f}".format(estimate.total_machine_assembly_hours) }} hrs</span>
                                        <br><small class="text-success">${{ "{:,.2f}".format(estimate.total_machine_assembly_cost) }}</small>
                                    </th>
                                    <th class="text-center">
                                        <strong class="text-info">${{ "{:,.2f}".format(estimate.total_labor_cost) }}</strong>
                                        <br><small class="text-muted">{{ "{:.2f}".format(estimate.total_hours) }} hrs</small>
                                    </th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                           class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Hours
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Assemblies to Estimate</h5>
                    <p class="text-muted">Add assemblies to this estimate before managing hours.</p>
                    <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                       class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> Back to Estimate
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function updateCosts(assemblyId) {
    // Get current values
    const engHours = parseFloat(document.querySelector(`input[name="engineering_hours_${assemblyId}"]`).value) || 0;
    const panelHours = parseFloat(document.querySelector(`input[name="panel_shop_hours_${assemblyId}"]`).value) || 0;
    const machineHours = parseFloat(document.querySelector(`input[name="machine_assembly_hours_${assemblyId}"]`).value) || 0;
    
    // Calculate costs
    const engCost = engHours * 145;
    const panelCost = panelHours * 125;
    const machineCost = machineHours * 125;
    const totalCost = engCost + panelCost + machineCost;
    const totalHours = engHours + panelHours + machineHours;
    
    // Update displays
    document.getElementById(`eng_cost_${assemblyId}`).textContent = `$${engCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`panel_cost_${assemblyId}`).textContent = `$${panelCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`machine_cost_${assemblyId}`).textContent = `$${machineCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`total_labor_${assemblyId}`).textContent = `$${totalCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`total_hours_${assemblyId}`).textContent = `${totalHours.toFixed(2)} hrs`;
}
</script>
{% endblock %}