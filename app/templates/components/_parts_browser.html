<!-- Reusable Parts Browser Component -->
<div class="card sticky-top" style="top: 20px;">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-database"></i> Parts Browser
        </h6>
        <small class="text-muted">{{ browser_subtitle or "Drag parts to add to assembly" }}</small>
    </div>
    <div class="card-body">
        <!-- Search and Filter -->
        <div class="mb-3">
            <div class="input-group mb-2">
                <input type="text" class="form-control form-control-sm" id="partsSearch" 
                       placeholder="Search parts..." style="font-size: 0.8rem;">
                <button class="btn btn-outline-secondary btn-sm" type="button" id="searchBtn" style="font-size: 0.8rem;">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="mb-2">
                <select class="form-select form-select-sm" id="categoryFilter" style="font-size: 0.8rem;">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="mb-2">
                <select class="form-select form-select-sm" id="manufacturerFilter" style="font-size: 0.8rem;">
                    <option value="">All Manufacturers</option>
                </select>
            </div>
        </div>
        
        <!-- Parts List -->
        <div id="partsContainer" class="border rounded p-2" style="height: 400px; overflow-y: auto;">
            <div id="partsLoader" class="text-center py-4">
                <i class="fas fa-spinner fa-spin"></i> Loading parts...
            </div>
            <div id="partsList"></div>
        </div>
        
        <!-- Quick Add Section -->
        <div class="mt-3">
            <small class="text-muted" style="font-size: 0.7rem;">
                <i class="fas fa-info-circle"></i>
                {{ browser_instructions or "Drag and drop parts or double-click to add" }}
            </small>
        </div>
    </div>
</div>

<!-- Parts Browser Styles -->
<style>
.part-item {
    cursor: grab;
    transition: all 0.2s ease;
    font-size: 0.85rem;
}

.part-item:hover {
    background-color: #f8f9fa !important;
    border-color: #007bff !important;
}

.part-item:active {
    cursor: grabbing;
}

.cursor-pointer {
    cursor: pointer;
}

/* Better text truncation with tooltips */
.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>

<!-- Parts Browser JavaScript -->
<script>
// Parts Browser functionality - can be customized by parent template
var PartsLibrary = {
    parts: [],
    searchEndpoint: '/parts/api/search',
    
    init: function() {
        this.loadCategories();
        this.loadManufacturers();
        this.searchParts();
        this.setupEventHandlers();
    },
    
    setupEventHandlers: function() {
        // Search functionality
        document.getElementById('searchBtn').addEventListener('click', () => this.searchParts());
        document.getElementById('partsSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.searchParts();
        });
        
        // Filter changes
        document.getElementById('categoryFilter').addEventListener('change', () => this.searchParts());
        document.getElementById('manufacturerFilter').addEventListener('change', () => this.searchParts());
    },
    
    loadCategories: function() {
        fetch('/parts/api/categories')
            .then(response => response.json())
            .then(data => {
                const categories = Array.isArray(data) ? data : (data.categories || []);
                const select = document.getElementById('categoryFilter');
                
                // Sort categories by name
                categories.sort((a, b) => {
                    const nameA = typeof a === 'string' ? a : a.name;
                    const nameB = typeof b === 'string' ? b : b.name;
                    return nameA.localeCompare(nameB);
                });
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    // Handle both string and object formats
                    if (typeof category === 'string') {
                        option.value = category;
                        option.textContent = category;
                    } else {
                        option.value = category.name;
                        option.textContent = category.name;
                    }
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading categories:', error));
    },
    
    loadManufacturers: function() {
        fetch('/parts/api/manufacturers')
            .then(response => response.json())
            .then(data => {
                const manufacturers = Array.isArray(data) ? data : (data.manufacturers || []);
                const select = document.getElementById('manufacturerFilter');
                manufacturers.sort().forEach(manufacturer => {
                    const option = document.createElement('option');
                    option.value = manufacturer;
                    option.textContent = manufacturer;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading manufacturers:', error));
    },
    
    searchParts: function() {
        const query = document.getElementById('partsSearch').value;
        const category = document.getElementById('categoryFilter').value;
        const manufacturer = document.getElementById('manufacturerFilter').value;
        
        const params = new URLSearchParams({
            q: query,
            category: category,
            manufacturer: manufacturer,
            limit: 100
        });
        
        document.getElementById('partsLoader').style.display = 'block';
        document.getElementById('partsList').innerHTML = '';
        
        fetch(this.searchEndpoint + '?' + params)
            .then(response => response.json())
            .then(data => {
                this.parts = data;
                this.renderParts();
            })
            .catch(error => {
                console.error('Error loading parts:', error);
                this.showMessage('error', 'Error', 'Failed to load parts');
            })
            .finally(() => {
                document.getElementById('partsLoader').style.display = 'none';
            });
    },
    
    renderParts: function() {
        const container = document.getElementById('partsList');
        container.innerHTML = '';
        
        if (this.parts.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">No parts found</div>';
            return;
        }
        
        this.parts.forEach(part => {
            const item = document.createElement('div');
            item.className = 'part-item border rounded p-2 mb-2 cursor-pointer';
            item.draggable = true;
            item.dataset.partId = part.part_id;
            
            // Store part data as a data attribute for easy access
            item.dataset.partData = JSON.stringify(part);
            
            item.innerHTML = `
                <div class="d-flex justify-content-between">
                    <div class="flex-grow-1" style="min-width: 0;">
                        <strong class="d-block text-truncate" style="font-size: 0.8rem;" title="${part.part_number || 'N/A'}">${part.part_number || 'N/A'}</strong>
                        <small class="text-muted text-truncate d-block" style="font-size: 0.75rem; line-height: 1.2;" title="${part.description || 'No description'}">${part.description || 'No description'}</small>
                        <div class="small text-secondary" style="font-size: 0.7rem;">
                            ${part.manufacturer || 'Unknown'} â€¢ $${(part.price || 0).toFixed(2)}
                        </div>
                    </div>
                    <div class="text-end flex-shrink-0">
                        <small class="badge bg-secondary" style="font-size: 0.65rem;" title="${part.category || 'N/A'}">${part.category || 'N/A'}</small>
                    </div>
                </div>
            `;
            
            // Enable dragging with better data transfer
            item.addEventListener('dragstart', (e) => {
                console.log('Drag started for part:', part.part_id, part);
                e.dataTransfer.setData('text/plain', part.part_id.toString());
                e.dataTransfer.setData('application/json', JSON.stringify(part));
                e.dataTransfer.effectAllowed = 'copy';
                
                // Add visual feedback
                item.style.opacity = '0.5';
            });
            
            item.addEventListener('dragend', (e) => {
                // Remove visual feedback
                item.style.opacity = '1';
            });
            
            // Double-click to select/add - customizable by parent
            item.addEventListener('dblclick', () => {
                console.log('Double click on part:', part.part_id, part);
                if (typeof onPartDoubleClick === 'function') {
                    onPartDoubleClick(part.part_id);
                }
            });
            
            container.appendChild(item);
        });
    },
    
    showMessage: function(type, title, message) {
        // Parent can override this method
        if (typeof showToast === 'function') {
            showToast(type, title, message);
        } else {
            console.log(`${type.toUpperCase()}: ${title} - ${message}`);
        }
    }
};
</script>