{% extends "base.html" %}

{% block title %}Manage Components - {{ assembly.assembly_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('projects.detail_project', project_id=assembly.estimate.project_id) }}">
                        {{ assembly.estimate.project.project_name }}
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('estimates.detail_estimate', estimate_id=assembly.estimate_id) }}">
                        {{ assembly.estimate.estimate_name }}
                    </a>
                </li>
                <li class="breadcrumb-item active">Manage {{ assembly.assembly_name }}</li>
            </ol>
        </nav>
        <h1>Component Management</h1>
        <p class="text-muted mb-0">{{ assembly.assembly_name }}</p>
    </div>
    <div class="d-flex gap-2">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked>
            <label class="form-check-label" for="autoSaveToggle">
                Auto-save <span id="autoSaveStatus" class="badge bg-success">ON</span>
            </label>
        </div>
        <button class="btn btn-outline-secondary" id="refreshBtn">
            <i class="fas fa-refresh"></i> Refresh
        </button>
        <a href="{{ url_for('estimates.detail_estimate', estimate_id=assembly.estimate_id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Estimate
        </a>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search components..." autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <small class="text-muted">Press Ctrl+F to focus search</small>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="uomFilter">
                    <option value="">All UOM</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" id="minPrice" placeholder="Min" step="0.01">
                    <span class="input-group-text">-</span>
                    <input type="number" class="form-control" id="maxPrice" placeholder="Max" step="0.01">
                </div>
            </div>
            <div class="col-md-3">
                <div class="btn-toolbar">
                    <div class="btn-group me-2">
                        <button class="btn btn-primary" id="addComponentBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                        <button class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" 
                                data-bs-toggle="dropdown">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="bulkDuplicateBtn">
                                <i class="fas fa-copy"></i> Duplicate Selected
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="bulkDeleteBtn">
                                <i class="fas fa-trash text-danger"></i> Delete Selected
                            </a></li>
                        </ul>
                    </div>
                    <button class="btn btn-outline-secondary" id="selectAllBtn">
                        <input type="checkbox" id="selectAllCheckbox" class="me-1"> Select All
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Data Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-0">Components</h5>
            <small class="text-muted">
                <span id="totalComponents">0</span> components | 
                <span id="selectedComponents">0</span> selected | 
                Total: $<span id="totalValue">0.00</span>
            </small>
        </div>
        <div id="savingIndicator" class="text-success" style="display: none;">
            <i class="fas fa-check-circle"></i> Saved
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="componentsTable">
                <thead class="table-light">
                    <tr>
                        <th width="40px">
                            <div class="resize-handle"></div>
                        </th>
                        <th class="sortable resizable" data-column="component_name">
                            Component Name <i class="fas fa-sort text-muted"></i>
                            <div class="resize-handle"></div>
                        </th>
                        <th class="sortable resizable" data-column="part_number">
                            Part Number <i class="fas fa-sort text-muted"></i>
                            <div class="resize-handle"></div>
                        </th>
                        <th class="resizable">
                            Description
                            <div class="resize-handle"></div>
                        </th>
                        <th class="sortable resizable" data-column="unit_price">
                            Unit Price <i class="fas fa-sort text-muted"></i>
                            <div class="resize-handle"></div>
                        </th>
                        <th class="sortable resizable" data-column="quantity">
                            Quantity <i class="fas fa-sort text-muted"></i>
                            <div class="resize-handle"></div>
                        </th>
                        <th class="sortable resizable" data-column="unit_of_measure">
                            UOM <i class="fas fa-sort text-muted"></i>
                            <div class="resize-handle"></div>
                        </th>
                        <th class="sortable resizable" data-column="total_price">
                            Total <i class="fas fa-sort text-muted"></i>
                            <div class="resize-handle"></div>
                        </th>
                        <th width="120px">Actions</th>
                    </tr>
                </thead>
                <tbody id="componentsTableBody">
                    <!-- Dynamic content loaded via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item" data-action="edit">
        <i class="fas fa-edit"></i> Edit
    </div>
    <div class="context-menu-item" data-action="duplicate">
        <i class="fas fa-copy"></i> Duplicate
    </div>
    <div class="context-menu-item" data-action="price-history">
        <i class="fas fa-chart-line"></i> Price History
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item text-danger" data-action="delete">
        <i class="fas fa-trash"></i> Delete
    </div>
</div>

<!-- Price History Modal -->
<div class="modal fade" id="priceHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Price History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <div class="h4 mb-0">$<span id="currentPrice">0.00</span></div>
                                <small>Current Price</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <div class="h4 mb-0"><span id="totalChanges">0</span></div>
                                <small>Total Changes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white" id="trendCard">
                            <div class="card-body text-center">
                                <div class="h4 mb-0">
                                    <i id="trendIcon" class="fas fa-minus"></i>
                                    <span id="trendText">Stable</span>
                                </div>
                                <small>Trend</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-secondary text-white">
                            <div class="card-body text-center">
                                <div class="h4 mb-0">$<span id="avgPrice">0.00</span></div>
                                <small>Average Price</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Price Trend Chart</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="priceChart" height="300"></canvas>
                    </div>
                </div>

                <!-- History Table -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Detailed Price History</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Old Price</th>
                                        <th>New Price</th>
                                        <th>Change</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
<script>
// Component Management System
class ComponentManager {
    constructor(assemblyId) {
        this.assemblyId = assemblyId;
        this.components = [];
        this.filteredComponents = [];
        this.selectedComponents = new Set();
        this.autoSave = true;
        this.editingCell = null;
        this.sortColumn = null;
        this.sortDirection = 'asc';
        this.chart = null;
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadComponents();
        this.setupKeyboardShortcuts();
    }
    
    bindEvents() {
        // Search and filters
        document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());
        document.getElementById('uomFilter').addEventListener('change', () => this.applyFilters());
        document.getElementById('minPrice').addEventListener('input', () => this.applyFilters());
        document.getElementById('maxPrice').addEventListener('input', () => this.applyFilters());
        document.getElementById('clearSearch').addEventListener('click', () => this.clearFilters());
        
        // Action buttons
        document.getElementById('addComponentBtn').addEventListener('click', () => this.addComponent());
        document.getElementById('bulkDeleteBtn').addEventListener('click', () => this.bulkDelete());
        document.getElementById('bulkDuplicateBtn').addEventListener('click', () => this.bulkDuplicate());
        document.getElementById('selectAllBtn').addEventListener('click', () => this.toggleSelectAll());
        document.getElementById('refreshBtn').addEventListener('click', () => this.loadComponents());
        
        // Auto-save toggle
        document.getElementById('autoSaveToggle').addEventListener('change', (e) => {
            this.autoSave = e.target.checked;
            const status = document.getElementById('autoSaveStatus');
            status.textContent = this.autoSave ? 'ON' : 'OFF';
            status.className = this.autoSave ? 'badge bg-success' : 'badge bg-secondary';
        });
        
        // Table sorting
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                this.sortTable(column);
            });
        });
        
        // Context menu
        document.addEventListener('contextmenu', (e) => this.showContextMenu(e));
        document.addEventListener('click', () => this.hideContextMenu());
        
        // Context menu actions
        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const action = item.dataset.action;
                const componentId = parseInt(document.getElementById('contextMenu').dataset.componentId);
                this.handleContextAction(action, componentId);
                this.hideContextMenu();
            });
        });
        
        // Column resizing
        this.setupColumnResizing();
    }
    
    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'a':
                        e.preventDefault();
                        this.selectAll();
                        break;
                    case 'f':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                    case 's':
                        e.preventDefault();
                        this.saveAllChanges();
                        break;
                }
            }
            
            if (e.key === 'Delete' && this.selectedComponents.size > 0) {
                this.bulkDelete();
            }
            
            if (e.key === 'Escape') {
                this.cancelEdit();
                this.hideContextMenu();
            }
        });
    }
    
    async loadComponents() {
        this.showLoading(true);
        try {
            const response = await fetch(`/components/api/list/${this.assemblyId}`);
            const data = await response.json();
            
            this.components = data;
            this.applyFilters();
            this.updateUOMFilter();
            this.updateSummary();
            
        } catch (error) {
            console.error('Error loading components:', error);
            this.showToast('Error loading components', 'error');
        }
        this.showLoading(false);
    }
    
    applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const uomFilter = document.getElementById('uomFilter').value;
        const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
        const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
        
        this.filteredComponents = this.components.filter(component => {
            const matchesSearch = !searchTerm || 
                component.component_name.toLowerCase().includes(searchTerm) ||
                (component.part_number || '').toLowerCase().includes(searchTerm) ||
                (component.description || '').toLowerCase().includes(searchTerm);
            
            const matchesUOM = !uomFilter || component.unit_of_measure === uomFilter;
            const matchesPrice = component.unit_price >= minPrice && component.unit_price <= maxPrice;
            
            return matchesSearch && matchesUOM && matchesPrice;
        });
        
        this.renderTable();
        this.updateSummary();
    }
    
    clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('uomFilter').value = '';
        document.getElementById('minPrice').value = '';
        document.getElementById('maxPrice').value = '';
        this.applyFilters();
    }
    
    updateUOMFilter() {
        const select = document.getElementById('uomFilter');
        const currentValue = select.value;
        
        // Get unique UOMs
        const uoms = [...new Set(this.components.map(c => c.unit_of_measure))].sort();
        
        select.innerHTML = '<option value="">All UOM</option>';
        uoms.forEach(uom => {
            const option = document.createElement('option');
            option.value = uom;
            option.textContent = uom;
            if (uom === currentValue) option.selected = true;
            select.appendChild(option);
        });
    }
    
    renderTable() {
        const tbody = document.getElementById('componentsTableBody');
        tbody.innerHTML = '';
        
        if (this.filteredComponents.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4 text-muted">
                        <i class="fas fa-search fa-2x mb-2"></i><br>
                        No components found matching your criteria
                    </td>
                </tr>
            `;
            return;
        }
        
        this.filteredComponents.forEach(component => {
            const row = this.createTableRow(component);
            tbody.appendChild(row);
        });
        
        // Restore selections
        this.selectedComponents.forEach(id => {
            const checkbox = document.querySelector(`input[data-component-id="${id}"]`);
            if (checkbox) checkbox.checked = true;
        });
        
        this.updateSelectAllState();
    }
    
    createTableRow(component) {
        const row = document.createElement('tr');
        row.className = 'component-row';
        row.dataset.componentId = component.component_id;
        
        row.innerHTML = `
            <td class="text-center">
                <input type="checkbox" class="form-check-input component-checkbox" 
                       data-component-id="${component.component_id}">
            </td>
            <td class="editable" data-field="component_name">${this.escapeHtml(component.component_name)}</td>
            <td class="editable" data-field="part_number">${this.escapeHtml(component.part_number || '')}</td>
            <td class="editable" data-field="description">${this.escapeHtml(component.description || '')}</td>
            <td class="editable text-end" data-field="unit_price" data-type="currency">$${component.unit_price.toFixed(2)}</td>
            <td class="editable text-end" data-field="quantity" data-type="number">${component.quantity}</td>
            <td class="editable" data-field="unit_of_measure">${component.unit_of_measure}</td>
            <td class="text-end fw-bold">$${component.total_price.toFixed(2)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-xs duplicate-btn" 
                            data-component-id="${component.component_id}" title="Duplicate">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn btn-outline-info btn-xs price-history-btn" 
                            data-component-id="${component.component_id}" title="Price History">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-xs delete-btn" 
                            data-component-id="${component.component_id}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        // Bind row events
        this.bindRowEvents(row);
        
        return row;
    }
    
    bindRowEvents(row) {
        // Checkbox selection
        const checkbox = row.querySelector('.component-checkbox');
        checkbox.addEventListener('change', (e) => {
            const componentId = parseInt(e.target.dataset.componentId);
            if (e.target.checked) {
                this.selectedComponents.add(componentId);
            } else {
                this.selectedComponents.delete(componentId);
            }
            this.updateSelectAllState();
            this.updateSummary();
        });
        
        // Row hover effects
        row.addEventListener('mouseenter', () => {
            row.classList.add('table-active');
            row.querySelectorAll('.btn-group').forEach(group => {
                group.style.opacity = '1';
            });
        });
        
        row.addEventListener('mouseleave', () => {
            row.classList.remove('table-active');
            if (!this.editingCell || !row.contains(this.editingCell)) {
                row.querySelectorAll('.btn-group').forEach(group => {
                    group.style.opacity = '0.7';
                });
            }
        });
        
        // Editable cells
        row.querySelectorAll('.editable').forEach(cell => {
            cell.addEventListener('click', () => this.startEdit(cell));
        });
        
        // Action buttons
        row.querySelector('.duplicate-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.duplicateComponent(parseInt(e.target.closest('.duplicate-btn').dataset.componentId));
        });
        
        row.querySelector('.price-history-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.showPriceHistory(parseInt(e.target.closest('.price-history-btn').dataset.componentId));
        });
        
        row.querySelector('.delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.deleteComponent(parseInt(e.target.closest('.delete-btn').dataset.componentId));
        });
    }
    
    startEdit(cell) {
        if (this.editingCell) {
            this.cancelEdit();
        }
        
        this.editingCell = cell;
        const originalValue = cell.textContent.replace('$', '');
        const field = cell.dataset.field;
        const type = cell.dataset.type || 'text';
        
        let input;
        if (field === 'unit_of_measure') {
            // Create dropdown for UOM
            input = document.createElement('select');
            input.className = 'form-select form-select-sm';
            
            const uoms = ['EA', 'LF', 'SF', 'CF', 'LB', 'GAL', 'HR', 'LOT'];
            uoms.forEach(uom => {
                const option = document.createElement('option');
                option.value = uom;
                option.textContent = uom;
                if (uom === originalValue) option.selected = true;
                input.appendChild(option);
            });
        } else {
            input = document.createElement('input');
            input.className = 'form-control form-control-sm';
            
            if (type === 'currency' || type === 'number') {
                input.type = 'number';
                input.step = type === 'currency' ? '0.01' : 'any';
            } else {
                input.type = 'text';
            }
            
            input.value = originalValue;
        }
        
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
        
        const saveEdit = async () => {
            const newValue = input.value;
            if (newValue !== originalValue) {
                await this.updateComponent(cell, field, newValue);
            } else {
                this.cancelEdit();
            }
        };
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                this.cancelEdit();
            }
        });
    }
    
    cancelEdit() {
        if (this.editingCell) {
            const componentId = parseInt(this.editingCell.closest('tr').dataset.componentId);
            const component = this.components.find(c => c.component_id === componentId);
            const field = this.editingCell.dataset.field;
            
            let displayValue = component[field] || '';
            if (this.editingCell.dataset.type === 'currency') {
                displayValue = '$' + parseFloat(displayValue).toFixed(2);
            }
            
            this.editingCell.textContent = displayValue;
            this.editingCell = null;
        }
    }
    
    async updateComponent(cell, field, value) {
        const row = cell.closest('tr');
        const componentId = parseInt(row.dataset.componentId);
        const component = this.components.find(c => c.component_id === componentId);
        
        if (!component) return;
        
        const updateData = { [field]: value };
        
        try {
            const response = await fetch(`/components/api/update/${componentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Update local data
                Object.assign(component, result.component);
                
                // Update display
                let displayValue = value;
                if (cell.dataset.type === 'currency') {
                    displayValue = '$' + parseFloat(value).toFixed(2);
                }
                cell.textContent = displayValue;
                
                // Update total column
                const totalCell = row.cells[7];
                totalCell.textContent = '$' + component.total_price.toFixed(2);
                
                this.editingCell = null;
                this.updateSummary();
                
                if (this.autoSave) {
                    this.showSaveIndicator();
                }
                
                this.showToast('Component updated successfully', 'success');
                
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Update failed');
            }
            
        } catch (error) {
            console.error('Update error:', error);
            this.showToast('Error updating component: ' + error.message, 'error');
            this.cancelEdit();
        }
    }
    
    async addComponent() {
        const newComponent = {
            component_name: 'New Component',
            description: '',
            part_number: '',
            unit_price: 0.00,
            quantity: 1.0,
            unit_of_measure: 'EA'
        };
        
        try {
            const response = await fetch(`/components/api/add/${this.assemblyId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newComponent)
            });
            
            if (response.ok) {
                const result = await response.json();
                this.components.push(result.component);
                this.applyFilters();
                this.updateUOMFilter();
                this.showToast('Component added successfully', 'success');
                
                // Start editing the new component name
                setTimeout(() => {
                    const newRow = document.querySelector(`tr[data-component-id="${result.component.component_id}"]`);
                    if (newRow) {
                        const nameCell = newRow.querySelector('[data-field="component_name"]');
                        this.startEdit(nameCell);
                    }
                }, 100);
                
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Add failed');
            }
            
        } catch (error) {
            console.error('Add error:', error);
            this.showToast('Error adding component: ' + error.message, 'error');
        }
    }
    
    async duplicateComponent(componentId) {
        try {
            const response = await fetch(`/components/api/duplicate/${componentId}`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                this.components.push(result.component);
                this.applyFilters();
                this.showToast('Component duplicated successfully', 'success');
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Duplicate failed');
            }
            
        } catch (error) {
            console.error('Duplicate error:', error);
            this.showToast('Error duplicating component: ' + error.message, 'error');
        }
    }
    
    async deleteComponent(componentId) {
        if (!confirm('Are you sure you want to delete this component?')) {
            return;
        }
        
        try {
            const response = await fetch(`/components/api/delete/${componentId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                this.components = this.components.filter(c => c.component_id !== componentId);
                this.selectedComponents.delete(componentId);
                this.applyFilters();
                this.showToast('Component deleted successfully', 'success');
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Delete failed');
            }
            
        } catch (error) {
            console.error('Delete error:', error);
            this.showToast('Error deleting component: ' + error.message, 'error');
        }
    }
    
    async bulkDelete() {
        if (this.selectedComponents.size === 0) {
            this.showToast('No components selected', 'warning');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete ${this.selectedComponents.size} component(s)?`)) {
            return;
        }
        
        const componentIds = Array.from(this.selectedComponents);
        
        try {
            const response = await fetch('/components/api/bulk-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ component_ids: componentIds })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Remove deleted components
                this.components = this.components.filter(c => !componentIds.includes(c.component_id));
                this.selectedComponents.clear();
                
                this.applyFilters();
                this.showToast(`${result.deleted_count} component(s) deleted successfully`, 'success');
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Bulk delete failed');
            }
            
        } catch (error) {
            console.error('Bulk delete error:', error);
            this.showToast('Error deleting components: ' + error.message, 'error');
        }
    }
    
    async bulkDuplicate() {
        if (this.selectedComponents.size === 0) {
            this.showToast('No components selected', 'warning');
            return;
        }
        
        const promises = Array.from(this.selectedComponents).map(id => 
            this.duplicateComponent(id)
        );
        
        try {
            await Promise.all(promises);
            this.selectedComponents.clear();
            this.showToast(`${promises.length} component(s) duplicated successfully`, 'success');
        } catch (error) {
            this.showToast('Error duplicating some components', 'error');
        }
    }
    
    toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const isChecked = selectAllCheckbox.checked;
        
        if (isChecked) {
            this.selectAll();
        } else {
            this.deselectAll();
        }
    }
    
    selectAll() {
        this.selectedComponents.clear();
        this.filteredComponents.forEach(component => {
            this.selectedComponents.add(component.component_id);
        });
        
        document.querySelectorAll('.component-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        
        this.updateSelectAllState();
        this.updateSummary();
    }
    
    deselectAll() {
        this.selectedComponents.clear();
        
        document.querySelectorAll('.component-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        this.updateSelectAllState();
        this.updateSummary();
    }
    
    updateSelectAllState() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const visibleComponents = this.filteredComponents.length;
        const selectedVisible = this.filteredComponents.filter(c => 
            this.selectedComponents.has(c.component_id)
        ).length;
        
        if (selectedVisible === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (selectedVisible === visibleComponents) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
    
    updateSummary() {
        const totalComponents = this.filteredComponents.length;
        const selectedCount = this.selectedComponents.size;
        const totalValue = this.filteredComponents.reduce((sum, c) => sum + c.total_price, 0);
        
        document.getElementById('totalComponents').textContent = totalComponents;
        document.getElementById('selectedComponents').textContent = selectedCount;
        document.getElementById('totalValue').textContent = totalValue.toFixed(2);
    }
    
    sortTable(column) {
        if (this.sortColumn === column) {
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            this.sortColumn = column;
            this.sortDirection = 'asc';
        }
        
        this.filteredComponents.sort((a, b) => {
            let valueA = a[column];
            let valueB = b[column];
            
            // Handle null/undefined values
            if (valueA == null) valueA = '';
            if (valueB == null) valueB = '';
            
            // Convert to numbers if needed
            if (typeof valueA === 'string' && !isNaN(parseFloat(valueA))) {
                valueA = parseFloat(valueA);
                valueB = parseFloat(valueB);
            }
            
            let result = 0;
            if (valueA < valueB) result = -1;
            if (valueA > valueB) result = 1;
            
            return this.sortDirection === 'desc' ? -result : result;
        });
        
        this.renderTable();
        this.updateSortIcons();
    }
    
    updateSortIcons() {
        // Reset all sort icons
        document.querySelectorAll('.sortable i').forEach(icon => {
            icon.className = 'fas fa-sort text-muted';
        });
        
        // Set active sort icon
        if (this.sortColumn) {
            const activeHeader = document.querySelector(`[data-column="${this.sortColumn}"] i`);
            if (activeHeader) {
                const iconClass = this.sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
                activeHeader.className = `fas ${iconClass} text-primary`;
            }
        }
    }
    
    showContextMenu(e) {
        const row = e.target.closest('.component-row');
        if (!row) return;
        
        e.preventDefault();
        
        const contextMenu = document.getElementById('contextMenu');
        const componentId = parseInt(row.dataset.componentId);
        
        contextMenu.dataset.componentId = componentId;
        contextMenu.style.display = 'block';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        
        // Ensure menu stays within viewport
        const rect = contextMenu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        if (rect.right > viewportWidth) {
            contextMenu.style.left = (e.pageX - rect.width) + 'px';
        }
        if (rect.bottom > viewportHeight) {
            contextMenu.style.top = (e.pageY - rect.height) + 'px';
        }
    }
    
    hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
    }
    
    handleContextAction(action, componentId) {
        switch (action) {
            case 'edit':
                const row = document.querySelector(`tr[data-component-id="${componentId}"]`);
                if (row) {
                    const nameCell = row.querySelector('[data-field="component_name"]');
                    this.startEdit(nameCell);
                }
                break;
            case 'duplicate':
                this.duplicateComponent(componentId);
                break;
            case 'price-history':
                this.showPriceHistory(componentId);
                break;
            case 'delete':
                this.deleteComponent(componentId);
                break;
        }
    }
    
    async showPriceHistory(componentId) {
        try {
            const response = await fetch(`/components/${componentId}/price-history-data`);
            const data = await response.json();
            
            // Update statistics
            document.getElementById('currentPrice').textContent = data.statistics.current_price.toFixed(2);
            document.getElementById('totalChanges').textContent = data.statistics.total_changes;
            document.getElementById('avgPrice').textContent = data.statistics.avg_price.toFixed(2);
            
            // Update trend
            const trendCard = document.getElementById('trendCard');
            const trendIcon = document.getElementById('trendIcon');
            const trendText = document.getElementById('trendText');
            
            trendCard.className = 'card text-white';
            switch (data.statistics.trend) {
                case 'rising':
                    trendCard.classList.add('bg-success');
                    trendIcon.className = 'fas fa-arrow-up';
                    trendText.textContent = 'Rising';
                    break;
                case 'falling':
                    trendCard.classList.add('bg-danger');
                    trendIcon.className = 'fas fa-arrow-down';
                    trendText.textContent = 'Falling';
                    break;
                default:
                    trendCard.classList.add('bg-secondary');
                    trendIcon.className = 'fas fa-minus';
                    trendText.textContent = 'Stable';
            }
            
            // Create chart
            this.createPriceChart(data.chart_data);
            
            // Update history table
            this.updateHistoryTable(data.detailed_history);
            
            // Update modal title
            document.querySelector('#priceHistoryModal .modal-title').textContent = 
                `Price History - ${data.component.name}`;
            
            // Show modal
            new bootstrap.Modal(document.getElementById('priceHistoryModal')).show();
            
        } catch (error) {
            console.error('Error loading price history:', error);
            this.showToast('Error loading price history', 'error');
        }
    }
    
    createPriceChart(chartData) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        if (this.chart) {
            this.chart.destroy();
        }
        
        this.chart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    
    updateHistoryTable(history) {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        
        if (history.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        No price history available
                    </td>
                </tr>
            `;
            return;
        }
        
        history.forEach(entry => {
            const row = document.createElement('tr');
            const changeClass = entry.change_amount > 0 ? 'text-success' : 
                               entry.change_amount < 0 ? 'text-danger' : 'text-muted';
            const changeIcon = entry.change_amount > 0 ? 'fa-arrow-up' : 
                              entry.change_amount < 0 ? 'fa-arrow-down' : 'fa-minus';
            
            row.innerHTML = `
                <td>${entry.date}</td>
                <td>$${entry.old_price.toFixed(2)}</td>
                <td>$${entry.new_price.toFixed(2)}</td>
                <td class="${changeClass}">
                    <i class="fas ${changeIcon}"></i>
                    $${Math.abs(entry.change_amount).toFixed(2)}
                </td>
                <td>${this.escapeHtml(entry.reason)}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    setupColumnResizing() {
        const resizeHandles = document.querySelectorAll('.resize-handle');
        let isResizing = false;
        let currentHandle = null;
        let startX = 0;
        let startWidth = 0;
        
        resizeHandles.forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                currentHandle = handle;
                startX = e.clientX;
                startWidth = handle.parentElement.offsetWidth;
                
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                
                e.preventDefault();
            });
        });
        
        function handleResize(e) {
            if (!isResizing || !currentHandle) return;
            
            const diff = e.clientX - startX;
            const newWidth = Math.max(50, startWidth + diff);
            currentHandle.parentElement.style.width = newWidth + 'px';
        }
        
        function stopResize() {
            isResizing = false;
            currentHandle = null;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }
    }
    
    showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = show ? 'flex' : 'none';
    }
    
    showSaveIndicator() {
        const indicator = document.getElementById('savingIndicator');
        indicator.style.display = 'block';
        
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    }
    
    showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast_' + Date.now();
        
        const bgClass = {
            'success': 'bg-success',
            'error': 'bg-danger',
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-info';
        
        const toast = document.createElement('div');
        toast.className = `toast ${bgClass} text-white`;
        toast.id = toastId;
        toast.setAttribute('role', 'alert');
        
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">Component Manager</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${this.escapeHtml(message)}
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return (text || '').replace(/[&<>"']/g, m => map[m]);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const assemblyId = {{ assembly.assembly_id }};
    window.componentManager = new ComponentManager(assemblyId);
});
</script>
{% endblock %}