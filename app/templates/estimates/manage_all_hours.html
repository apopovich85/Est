{% extends "base.html" %}

{% block title %}Manage Hours - {{ estimate.estimate_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">Manage Labor Hours</h5>
                    <small class="text-muted">{{ estimate.estimate_name }} | Project: {{ estimate.project.project_name }}</small>
                </div>
                <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Estimate
                </a>
            </div>
            
            <div class="card-body">
                <form method="POST" action="{{ url_for('estimates.update_all_hours', estimate_id=estimate.estimate_id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    {% if assemblies %}
                    <!-- Assemblies Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cubes"></i> Assembly Hours
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 25%">Assembly Name</th>
                                        <th style="width: 12%" class="text-center">Engineering<br><small class="text-muted">${{ "%.0f"|format(estimate.engineering_rate) }}/hr</small></th>
                                        <th style="width: 12%" class="text-center">Panel Shop<br><small class="text-muted">${{ "%.0f"|format(estimate.panel_shop_rate) }}/hr</small></th>
                                        <th style="width: 12%" class="text-center">Machine Assembly<br><small class="text-muted">${{ "%.0f"|format(estimate.machine_assembly_rate) }}/hr</small></th>
                                        <th style="width: 15%" class="text-center">Total Labor Cost</th>
                                        <th style="width: 12%">Estimated By</th>
                                        <th style="width: 12%">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assembly in assemblies %}
                                    <tr>
                                        <td>
                                            <strong>{{ assembly.assembly_name }}</strong>
                                            {% if assembly.description %}
                                                <br><small class="text-muted">{{ assembly.description }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="assembly_engineering_hours_{{ assembly.assembly_id }}" 
                                                   value="{{ assembly.engineering_hours or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateAssemblyCost({{ assembly.assembly_id }})">
                                            <small class="text-primary d-block mt-1" id="assembly_eng_cost_{{ assembly.assembly_id }}">
                                                ${{ "{:,.2f}".format(assembly.calculated_engineering_cost) }}
                                            </small>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="assembly_panel_shop_hours_{{ assembly.assembly_id }}" 
                                                   value="{{ assembly.panel_shop_hours or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateAssemblyCost({{ assembly.assembly_id }})">
                                            <small class="text-warning d-block mt-1" id="assembly_panel_cost_{{ assembly.assembly_id }}">
                                                ${{ "{:,.2f}".format(assembly.calculated_panel_shop_cost) }}
                                            </small>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="assembly_machine_assembly_hours_{{ assembly.assembly_id }}" 
                                                   value="{{ assembly.machine_assembly_hours or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateAssemblyCost({{ assembly.assembly_id }})">
                                            <small class="text-success d-block mt-1" id="assembly_machine_cost_{{ assembly.assembly_id }}">
                                                ${{ "{:,.2f}".format(assembly.calculated_machine_assembly_cost) }}
                                            </small>
                                        </td>
                                        <td class="text-center">
                                            <strong class="text-info" id="assembly_total_labor_{{ assembly.assembly_id }}">
                                                ${{ "{:,.2f}".format(assembly.total_labor_cost) }}
                                            </strong>
                                            <br><small class="text-muted" id="assembly_total_hours_{{ assembly.assembly_id }}">
                                                {{ "{:.2f}".format(assembly.total_hours) }} hrs
                                            </small>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" 
                                                   name="assembly_estimated_by_{{ assembly.assembly_id }}" 
                                                   value="{{ assembly.estimated_by or '' }}"
                                                   placeholder="Estimator">
                                        </td>
                                        <td>
                                            <textarea class="form-control form-control-sm" 
                                                      name="assembly_time_estimate_notes_{{ assembly.assembly_id }}" 
                                                      rows="2" placeholder="Notes...">{{ assembly.time_estimate_notes or '' }}</textarea>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th><strong>Assembly Totals:</strong></th>
                                        <th class="text-center">
                                            <span class="text-primary" id="total_assembly_eng_hours">{{ "{:.2f}".format(estimate.total_engineering_hours) }} hrs</span>
                                            <br><small class="text-primary" id="total_assembly_eng_cost">${{ "{:,.2f}".format(estimate.total_engineering_cost) }}</small>
                                        </th>
                                        <th class="text-center">
                                            <span class="text-warning" id="total_assembly_panel_hours">{{ "{:.2f}".format(estimate.total_panel_shop_hours) }} hrs</span>
                                            <br><small class="text-warning" id="total_assembly_panel_cost">${{ "{:,.2f}".format(estimate.total_panel_shop_cost) }}</small>
                                        </th>
                                        <th class="text-center">
                                            <span class="text-success" id="total_assembly_machine_hours">{{ "{:.2f}".format(estimate.total_machine_assembly_hours) }} hrs</span>
                                            <br><small class="text-success" id="total_assembly_machine_cost">${{ "{:,.2f}".format(estimate.total_machine_assembly_cost) }}</small>
                                        </th>
                                        <th class="text-center">
                                            <strong class="text-info" id="total_assembly_labor_cost">${{ "{:,.2f}".format(estimate.total_labor_cost) }}</strong>
                                            <br><small class="text-muted" id="total_assembly_hours">{{ "{:.2f}".format(estimate.total_hours) }} hrs</small>
                                        </th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    {% if individual_components %}
                    <!-- Individual Components Section -->
                    <div class="mb-4">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-cog"></i> Individual Component Hours
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 15%">Component Name</th>
                                        <th style="width: 8%" class="text-center">Qty</th>
                                        <th style="width: 10%" class="text-center">Engineering<br><small class="text-muted">Total</small></th>
                                        <th style="width: 10%" class="text-center">Panel Shop<br><small class="text-muted">Total</small></th>
                                        <th style="width: 10%" class="text-center">Machine Assembly<br><small class="text-muted">Total</small></th>
                                        <th style="width: 10%" class="text-center">Engineering<br><small class="text-muted">Per Assembly</small></th>
                                        <th style="width: 10%" class="text-center">Panel Shop<br><small class="text-muted">Per Assembly</small></th>
                                        <th style="width: 10%" class="text-center">Machine Assembly<br><small class="text-muted">Per Assembly</small></th>
                                        <th style="width: 12%" class="text-center">Total Labor Cost</th>
                                        <th style="width: 5%">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for component in individual_components %}
                                    <tr>
                                        <td>
                                            <strong>{{ component.component_name }}</strong>
                                            {% if component.part_number %}
                                                <br><small class="text-muted">{{ component.part_number }}</small>
                                            {% endif %}
                                            {% if component.manufacturer %}
                                                <br><small class="text-muted">{{ component.manufacturer }}</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <strong>{{ "%.0f"|format(component.quantity) }}</strong>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="component_engineering_hours_{{ component.estimate_component_id }}" 
                                                   value="{{ component.engineering_hours or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateComponentCost({{ component.estimate_component_id }})">
                                            <small class="text-primary d-block mt-1" id="component_eng_total_{{ component.estimate_component_id }}">
                                                {{ "{:.2f}".format(component.total_engineering_hours) }}h total
                                            </small>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="component_panel_shop_hours_{{ component.estimate_component_id }}" 
                                                   value="{{ component.panel_shop_hours or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateComponentCost({{ component.estimate_component_id }})">
                                            <small class="text-warning d-block mt-1" id="component_panel_total_{{ component.estimate_component_id }}">
                                                {{ "{:.2f}".format(component.total_panel_shop_hours) }}h total
                                            </small>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="component_machine_assembly_hours_{{ component.estimate_component_id }}" 
                                                   value="{{ component.machine_assembly_hours or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateComponentCost({{ component.estimate_component_id }})">
                                            <small class="text-success d-block mt-1" id="component_machine_total_{{ component.estimate_component_id }}">
                                                {{ "{:.2f}".format(component.total_machine_assembly_hours) }}h total
                                            </small>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="component_engineering_hours_per_assembly_{{ component.estimate_component_id }}" 
                                                   value="{{ component.engineering_hours_per_assembly or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateComponentCost({{ component.estimate_component_id }})">
                                            <small class="text-muted d-block mt-1">×{{ "%.0f"|format(component.quantity) }} = {{ "{:.2f}".format((component.engineering_hours_per_assembly or 0) * component.quantity) }}h</small>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="component_panel_shop_hours_per_assembly_{{ component.estimate_component_id }}" 
                                                   value="{{ component.panel_shop_hours_per_assembly or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateComponentCost({{ component.estimate_component_id }})">
                                            <small class="text-muted d-block mt-1">×{{ "%.0f"|format(component.quantity) }} = {{ "{:.2f}".format((component.panel_shop_hours_per_assembly or 0) * component.quantity) }}h</small>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   name="component_machine_assembly_hours_per_assembly_{{ component.estimate_component_id }}" 
                                                   value="{{ component.machine_assembly_hours_per_assembly or 0 }}"
                                                   step="0.25" min="0" placeholder="0.0"
                                                   onchange="updateComponentCost({{ component.estimate_component_id }})">
                                            <small class="text-muted d-block mt-1">×{{ "%.0f"|format(component.quantity) }} = {{ "{:.2f}".format((component.machine_assembly_hours_per_assembly or 0) * component.quantity) }}h</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="text-success fw-bold" id="component_cost_{{ component.estimate_component_id }}">
                                                ${{ "%.2f"|format(component.total_labor_cost) }}
                                            </span>
                                        </td>
                                        <td>
                                            <textarea class="form-control form-control-sm" 
                                                      name="component_time_estimate_notes_{{ component.estimate_component_id }}" 
                                                      rows="2" placeholder="Notes">{{ component.time_estimate_notes or '' }}</textarea>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <td><strong>Component Totals:</strong></td>
                                        <td></td>
                                        <td class="text-center"><strong id="total_component_eng_hours">{{ "%.2f"|format(individual_components|sum(attribute='total_engineering_hours')) }}h</strong></td>
                                        <td class="text-center"><strong id="total_component_panel_hours">{{ "%.2f"|format(individual_components|sum(attribute='total_panel_shop_hours')) }}h</strong></td>
                                        <td class="text-center"><strong id="total_component_machine_hours">{{ "%.2f"|format(individual_components|sum(attribute='total_machine_assembly_hours')) }}h</strong></td>
                                        <td class="text-center"><strong>{{ "%.2f"|format(individual_components|sum(attribute='engineering_hours_per_assembly')) }}h</strong></td>
                                        <td class="text-center"><strong>{{ "%.2f"|format(individual_components|sum(attribute='panel_shop_hours_per_assembly')) }}h</strong></td>
                                        <td class="text-center"><strong>{{ "%.2f"|format(individual_components|sum(attribute='machine_assembly_hours_per_assembly')) }}h</strong></td>
                                        <td class="text-center"><strong class="text-success" id="total_component_labor_cost">${{ "%.2f"|format(individual_components|sum(attribute='total_labor_cost')) }}</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    {% if not assemblies and not individual_components %}
                    <div class="text-center py-5">
                        <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Items to Estimate</h5>
                        <p class="text-muted mb-4">Add assemblies or individual components to this estimate before managing hours.</p>
                        <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                           class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Back to Estimate
                        </a>
                    </div>
                    {% else %}
                    <!-- Grand Totals -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-center mb-3">
                                        <i class="fas fa-calculator"></i> Grand Totals
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <h6 class="text-primary">Engineering</h6>
                                            <div id="grand_total_eng_hours" class="h5 text-primary">
                                                {{ "%.2f"|format(estimate.total_engineering_hours) }}h
                                            </div>
                                            <small class="text-muted" id="grand_total_eng_cost">
                                                ${{ "%.2f"|format(estimate.total_engineering_cost) }}
                                            </small>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-warning">Panel Shop</h6>
                                            <div id="grand_total_panel_hours" class="h5 text-warning">
                                                {{ "%.2f"|format(estimate.total_panel_shop_hours) }}h
                                            </div>
                                            <small class="text-muted" id="grand_total_panel_cost">
                                                ${{ "%.2f"|format(estimate.total_panel_shop_cost) }}
                                            </small>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-success">Machine Assembly</h6>
                                            <div id="grand_total_machine_hours" class="h5 text-success">
                                                {{ "%.2f"|format(estimate.total_machine_assembly_hours) }}h
                                            </div>
                                            <small class="text-muted" id="grand_total_machine_cost">
                                                ${{ "%.2f"|format(estimate.total_machine_assembly_cost) }}
                                            </small>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-info">Total Labor</h6>
                                            <div id="grand_total_labor_cost" class="h4 text-info">
                                                ${{ "%.2f"|format(estimate.total_labor_cost) }}
                                            </div>
                                            <small class="text-muted" id="grand_total_hours">
                                                {{ "%.2f"|format(estimate.total_hours) }} hrs
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                                   class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save All Time Estimates
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Assembly cost calculation
function updateAssemblyCost(assemblyId) {
    const engHours = parseFloat(document.querySelector(`input[name="assembly_engineering_hours_${assemblyId}"]`).value) || 0;
    const panelHours = parseFloat(document.querySelector(`input[name="assembly_panel_shop_hours_${assemblyId}"]`).value) || 0;
    const machineHours = parseFloat(document.querySelector(`input[name="assembly_machine_assembly_hours_${assemblyId}"]`).value) || 0;
    
    const engRate = {{ estimate.engineering_rate }};
    const panelRate = {{ estimate.panel_shop_rate }};
    const machineRate = {{ estimate.machine_assembly_rate }};
    
    const engCost = engHours * engRate;
    const panelCost = panelHours * panelRate;
    const machineCost = machineHours * machineRate;
    const totalCost = engCost + panelCost + machineCost;
    const totalHours = engHours + panelHours + machineHours;
    
    // Update displays
    document.getElementById(`assembly_eng_cost_${assemblyId}`).textContent = `$${engCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`assembly_panel_cost_${assemblyId}`).textContent = `$${panelCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`assembly_machine_cost_${assemblyId}`).textContent = `$${machineCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`assembly_total_labor_${assemblyId}`).textContent = `$${totalCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById(`assembly_total_hours_${assemblyId}`).textContent = `${totalHours.toFixed(2)} hrs`;
    
    updateGrandTotals();
}

// Component cost calculation
function updateComponentCost(componentId) {
    const engHours = parseFloat(document.querySelector(`input[name="component_engineering_hours_${componentId}"]`).value) || 0;
    const panelHours = parseFloat(document.querySelector(`input[name="component_panel_shop_hours_${componentId}"]`).value) || 0;
    const machineHours = parseFloat(document.querySelector(`input[name="component_machine_assembly_hours_${componentId}"]`).value) || 0;
    
    const engHoursPerAssembly = parseFloat(document.querySelector(`input[name="component_engineering_hours_per_assembly_${componentId}"]`).value) || 0;
    const panelHoursPerAssembly = parseFloat(document.querySelector(`input[name="component_panel_shop_hours_per_assembly_${componentId}"]`).value) || 0;
    const machineHoursPerAssembly = parseFloat(document.querySelector(`input[name="component_machine_assembly_hours_per_assembly_${componentId}"]`).value) || 0;
    
    // Get quantity from the component data (assuming it's available in the template)
    const quantity = parseFloat(document.querySelector(`tr:has(input[name="component_engineering_hours_${componentId}"])`).querySelector('td:nth-child(2) strong').textContent) || 1;
    
    const engRate = {{ estimate.engineering_rate }};
    const panelRate = {{ estimate.panel_shop_rate }};
    const machineRate = {{ estimate.machine_assembly_rate }};
    
    // Calculate total hours (base + per-assembly * quantity)
    const totalEngHours = engHours + (engHoursPerAssembly * quantity);
    const totalPanelHours = panelHours + (panelHoursPerAssembly * quantity);
    const totalMachineHours = machineHours + (machineHoursPerAssembly * quantity);
    
    // Update total hours displays
    const engTotalDisplay = document.getElementById(`component_eng_total_${componentId}`);
    if (engTotalDisplay) {
        engTotalDisplay.textContent = `${totalEngHours.toFixed(2)}h total`;
    }
    
    const panelTotalDisplay = document.getElementById(`component_panel_total_${componentId}`);
    if (panelTotalDisplay) {
        panelTotalDisplay.textContent = `${totalPanelHours.toFixed(2)}h total`;
    }
    
    const machineTotalDisplay = document.getElementById(`component_machine_total_${componentId}`);
    if (machineTotalDisplay) {
        machineTotalDisplay.textContent = `${totalMachineHours.toFixed(2)}h total`;
    }
    
    // Calculate total cost using total hours
    const totalCost = (totalEngHours * engRate) + (totalPanelHours * panelRate) + (totalMachineHours * machineRate);
    
    document.getElementById(`component_cost_${componentId}`).textContent = `$${totalCost.toFixed(2)}`;
    
    updateComponentTotals();
    updateGrandTotals();
}

// Update component section totals
function updateComponentTotals() {
    let totalEngHours = 0;
    let totalPanelHours = 0;
    let totalMachineHours = 0;
    let totalLaborCost = 0;
    
    {% for component in individual_components %}
    const eng{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_engineering_hours_{{ component.estimate_component_id }}"]').value) || 0;
    const panel{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_panel_shop_hours_{{ component.estimate_component_id }}"]').value) || 0;
    const machine{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_machine_assembly_hours_{{ component.estimate_component_id }}"]').value) || 0;
    
    const engPerAssembly{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_engineering_hours_per_assembly_{{ component.estimate_component_id }}"]').value) || 0;
    const panelPerAssembly{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_panel_shop_hours_per_assembly_{{ component.estimate_component_id }}"]').value) || 0;
    const machinePerAssembly{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_machine_assembly_hours_per_assembly_{{ component.estimate_component_id }}"]').value) || 0;
    
    const quantity{{ component.estimate_component_id }} = {{ component.quantity }};
    
    // Calculate total hours (base + per-assembly * quantity)
    const totalEngHours{{ component.estimate_component_id }} = eng{{ component.estimate_component_id }} + (engPerAssembly{{ component.estimate_component_id }} * quantity{{ component.estimate_component_id }});
    const totalPanelHours{{ component.estimate_component_id }} = panel{{ component.estimate_component_id }} + (panelPerAssembly{{ component.estimate_component_id }} * quantity{{ component.estimate_component_id }});
    const totalMachineHours{{ component.estimate_component_id }} = machine{{ component.estimate_component_id }} + (machinePerAssembly{{ component.estimate_component_id }} * quantity{{ component.estimate_component_id }});
    
    totalEngHours += totalEngHours{{ component.estimate_component_id }};
    totalPanelHours += totalPanelHours{{ component.estimate_component_id }};
    totalMachineHours += totalMachineHours{{ component.estimate_component_id }};
    
    const componentCost = (totalEngHours{{ component.estimate_component_id }} * {{ estimate.engineering_rate }}) + 
                         (totalPanelHours{{ component.estimate_component_id }} * {{ estimate.panel_shop_rate }}) + 
                         (totalMachineHours{{ component.estimate_component_id }} * {{ estimate.machine_assembly_rate }});
    totalLaborCost += componentCost;
    {% endfor %}
    
    if (document.getElementById('total_component_eng_hours')) {
        document.getElementById('total_component_eng_hours').textContent = `${totalEngHours.toFixed(2)}h`;
        document.getElementById('total_component_panel_hours').textContent = `${totalPanelHours.toFixed(2)}h`;
        document.getElementById('total_component_machine_hours').textContent = `${totalMachineHours.toFixed(2)}h`;
        document.getElementById('total_component_labor_cost').textContent = `$${totalLaborCost.toFixed(2)}`;
    }
}

// Update grand totals
function updateGrandTotals() {
    // Assembly totals (from existing totals or calculate from inputs)
    let assemblyEngHours = 0;
    let assemblyPanelHours = 0;
    let assemblyMachineHours = 0;
    
    {% for assembly in assemblies %}
    const aEng{{ assembly.assembly_id }} = parseFloat(document.querySelector('input[name="assembly_engineering_hours_{{ assembly.assembly_id }}"]').value) || 0;
    const aPanel{{ assembly.assembly_id }} = parseFloat(document.querySelector('input[name="assembly_panel_shop_hours_{{ assembly.assembly_id }}"]').value) || 0;
    const aMachine{{ assembly.assembly_id }} = parseFloat(document.querySelector('input[name="assembly_machine_assembly_hours_{{ assembly.assembly_id }}"]').value) || 0;
    
    assemblyEngHours += aEng{{ assembly.assembly_id }};
    assemblyPanelHours += aPanel{{ assembly.assembly_id }};
    assemblyMachineHours += aMachine{{ assembly.assembly_id }};
    {% endfor %}
    
    // Component totals
    let componentEngHours = 0;
    let componentPanelHours = 0;
    let componentMachineHours = 0;
    
    {% for component in individual_components %}
    const cEng{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_engineering_hours_{{ component.estimate_component_id }}"]').value) || 0;
    const cPanel{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_panel_shop_hours_{{ component.estimate_component_id }}"]').value) || 0;
    const cMachine{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_machine_assembly_hours_{{ component.estimate_component_id }}"]').value) || 0;
    
    const cEngPerAssembly{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_engineering_hours_per_assembly_{{ component.estimate_component_id }}"]').value) || 0;
    const cPanelPerAssembly{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_panel_shop_hours_per_assembly_{{ component.estimate_component_id }}"]').value) || 0;
    const cMachinePerAssembly{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="component_machine_assembly_hours_per_assembly_{{ component.estimate_component_id }}"]').value) || 0;
    
    const cQuantity{{ component.estimate_component_id }} = {{ component.quantity }};
    
    // Calculate total component hours (base + per-assembly * quantity)
    const cTotalEngHours{{ component.estimate_component_id }} = cEng{{ component.estimate_component_id }} + (cEngPerAssembly{{ component.estimate_component_id }} * cQuantity{{ component.estimate_component_id }});
    const cTotalPanelHours{{ component.estimate_component_id }} = cPanel{{ component.estimate_component_id }} + (cPanelPerAssembly{{ component.estimate_component_id }} * cQuantity{{ component.estimate_component_id }});
    const cTotalMachineHours{{ component.estimate_component_id }} = cMachine{{ component.estimate_component_id }} + (cMachinePerAssembly{{ component.estimate_component_id }} * cQuantity{{ component.estimate_component_id }});
    
    componentEngHours += cTotalEngHours{{ component.estimate_component_id }};
    componentPanelHours += cTotalPanelHours{{ component.estimate_component_id }};
    componentMachineHours += cTotalMachineHours{{ component.estimate_component_id }};
    {% endfor %}
    
    // Grand totals
    const grandEngHours = assemblyEngHours + componentEngHours;
    const grandPanelHours = assemblyPanelHours + componentPanelHours;
    const grandMachineHours = assemblyMachineHours + componentMachineHours;
    const grandTotalHours = grandEngHours + grandPanelHours + grandMachineHours;
    
    const engRate = {{ estimate.engineering_rate }};
    const panelRate = {{ estimate.panel_shop_rate }};
    const machineRate = {{ estimate.machine_assembly_rate }};
    
    const grandEngCost = grandEngHours * engRate;
    const grandPanelCost = grandPanelHours * panelRate;
    const grandMachineCost = grandMachineHours * machineRate;
    const grandTotalCost = grandEngCost + grandPanelCost + grandMachineCost;
    
    // Update grand totals display
    if (document.getElementById('grand_total_eng_hours')) {
        document.getElementById('grand_total_eng_hours').textContent = `${grandEngHours.toFixed(2)}h`;
        document.getElementById('grand_total_eng_cost').textContent = `$${grandEngCost.toFixed(2)}`;
        document.getElementById('grand_total_panel_hours').textContent = `${grandPanelHours.toFixed(2)}h`;
        document.getElementById('grand_total_panel_cost').textContent = `$${grandPanelCost.toFixed(2)}`;
        document.getElementById('grand_total_machine_hours').textContent = `${grandMachineHours.toFixed(2)}h`;
        document.getElementById('grand_total_machine_cost').textContent = `$${grandMachineCost.toFixed(2)}`;
        document.getElementById('grand_total_labor_cost').textContent = `$${grandTotalCost.toFixed(2)}`;
        document.getElementById('grand_total_hours').textContent = `${grandTotalHours.toFixed(2)} hrs`;
    }
}
</script>
{% endblock %}