{% extends "base.html" %}

{% block title %}Manage Component Hours - {{ estimate.estimate_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">Manage Individual Component Labor Hours</h5>
                    <small class="text-muted">{{ estimate.estimate_name }} | Project: {{ estimate.project.project_name }}</small>
                </div>
                <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Estimate
                </a>
            </div>
            
            <div class="card-body">
                {% if components %}
                <form method="POST" action="{{ url_for('estimates.update_component_hours', estimate_id=estimate.estimate_id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">Component Name</th>
                                    <th style="width: 12%" class="text-center">Engineering<br><small class="text-muted">${{ "%.0f"|format(estimate.engineering_rate) }}/hr</small></th>
                                    <th style="width: 12%" class="text-center">Panel Shop<br><small class="text-muted">${{ "%.0f"|format(estimate.panel_shop_rate) }}/hr</small></th>
                                    <th style="width: 12%" class="text-center">Machine Assembly<br><small class="text-muted">${{ "%.0f"|format(estimate.machine_assembly_rate) }}/hr</small></th>
                                    <th style="width: 15%" class="text-center">Total Labor Cost</th>
                                    <th style="width: 12%">Estimated By</th>
                                    <th style="width: 12%">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for component in components %}
                                <tr>
                                    <td>
                                        <strong>{{ component.component_name }}</strong>
                                        {% if component.part_number %}
                                            <br><small class="text-muted">{{ component.part_number }}</small>
                                        {% endif %}
                                        {% if component.manufacturer %}
                                            <br><small class="text-muted">{{ component.manufacturer }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               name="engineering_hours_{{ component.estimate_component_id }}" 
                                               value="{{ component.engineering_hours or 0 }}"
                                               step="0.25" min="0" placeholder="0.0"
                                               onchange="updateComponentCost({{ component.estimate_component_id }})">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               name="panel_shop_hours_{{ component.estimate_component_id }}" 
                                               value="{{ component.panel_shop_hours or 0 }}"
                                               step="0.25" min="0" placeholder="0.0"
                                               onchange="updateComponentCost({{ component.estimate_component_id }})">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-center" 
                                               name="machine_assembly_hours_{{ component.estimate_component_id }}" 
                                               value="{{ component.machine_assembly_hours or 0 }}"
                                               step="0.25" min="0" placeholder="0.0"
                                               onchange="updateComponentCost({{ component.estimate_component_id }})">
                                    </td>
                                    <td class="text-center">
                                        <span class="text-success fw-bold" id="cost_{{ component.estimate_component_id }}">
                                            ${{ "%.2f"|format(component.total_labor_cost) }}
                                        </span>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" 
                                               name="estimated_by_{{ component.estimate_component_id }}" 
                                               value="{{ component.estimated_by or '' }}"
                                               placeholder="Estimator">
                                    </td>
                                    <td>
                                        <textarea class="form-control form-control-sm" 
                                                  name="time_estimate_notes_{{ component.estimate_component_id }}" 
                                                  rows="2" placeholder="Notes">{{ component.time_estimate_notes or '' }}</textarea>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <td><strong>Totals:</strong></td>
                                    <td class="text-center"><strong id="total_eng_hours">{{ "%.2f"|format(components|sum(attribute='engineering_hours')) }}h</strong></td>
                                    <td class="text-center"><strong id="total_panel_hours">{{ "%.2f"|format(components|sum(attribute='panel_shop_hours')) }}h</strong></td>
                                    <td class="text-center"><strong id="total_machine_hours">{{ "%.2f"|format(components|sum(attribute='machine_assembly_hours')) }}h</strong></td>
                                    <td class="text-center"><strong class="text-success" id="total_labor_cost">${{ "%.2f"|format(components|sum(attribute='total_labor_cost')) }}</strong></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                                   class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Time Estimates
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Individual Components</h5>
                    <p class="text-muted mb-4">This estimate doesn't have any individual components to manage hours for.</p>
                    <a href="{{ url_for('estimates.detail_estimate', estimate_id=estimate.estimate_id) }}" 
                       class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> Back to Estimate
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateComponentCost(componentId) {
    // Get the current hour values
    const engHours = parseFloat(document.querySelector(`input[name="engineering_hours_${componentId}"]`).value) || 0;
    const panelHours = parseFloat(document.querySelector(`input[name="panel_shop_hours_${componentId}"]`).value) || 0;
    const machineHours = parseFloat(document.querySelector(`input[name="machine_assembly_hours_${componentId}"]`).value) || 0;
    
    // Calculate costs using estimate rates
    const engRate = {{ estimate.engineering_rate }};
    const panelRate = {{ estimate.panel_shop_rate }};
    const machineRate = {{ estimate.machine_assembly_rate }};
    
    const totalCost = (engHours * engRate) + (panelHours * panelRate) + (machineHours * machineRate);
    
    // Update the cost display
    document.getElementById(`cost_${componentId}`).textContent = `$${totalCost.toFixed(2)}`;
    
    // Update totals
    updateTotals();
}

function updateTotals() {
    let totalEngHours = 0;
    let totalPanelHours = 0;
    let totalMachineHours = 0;
    let totalLaborCost = 0;
    
    // Sum up all the hours
    {% for component in components %}
    const eng{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="engineering_hours_{{ component.estimate_component_id }}"]').value) || 0;
    const panel{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="panel_shop_hours_{{ component.estimate_component_id }}"]').value) || 0;
    const machine{{ component.estimate_component_id }} = parseFloat(document.querySelector('input[name="machine_assembly_hours_{{ component.estimate_component_id }}"]').value) || 0;
    
    totalEngHours += eng{{ component.estimate_component_id }};
    totalPanelHours += panel{{ component.estimate_component_id }};
    totalMachineHours += machine{{ component.estimate_component_id }};
    
    const componentCost = (eng{{ component.estimate_component_id }} * {{ estimate.engineering_rate }}) + 
                         (panel{{ component.estimate_component_id }} * {{ estimate.panel_shop_rate }}) + 
                         (machine{{ component.estimate_component_id }} * {{ estimate.machine_assembly_rate }});
    totalLaborCost += componentCost;
    {% endfor %}
    
    // Update the totals display
    document.getElementById('total_eng_hours').textContent = `${totalEngHours.toFixed(2)}h`;
    document.getElementById('total_panel_hours').textContent = `${totalPanelHours.toFixed(2)}h`;
    document.getElementById('total_machine_hours').textContent = `${totalMachineHours.toFixed(2)}h`;
    document.getElementById('total_labor_cost').textContent = `$${totalLaborCost.toFixed(2)}`;
}
</script>
{% endblock %}